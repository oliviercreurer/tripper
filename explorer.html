<!doctype html>
<html lang="en" style="--body-font: &quot;Outfit&quot;">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Explorer</title>
        <link href="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.css" rel="stylesheet" />
        <script src="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&family=Platypi:wght@400;500;600&family=Lato:wght@400;700;900&family=JetBrains+Mono:wght@400&display=swap"
            rel="stylesheet"
        />
        <style>
            /* ─── Design tokens (light mode) ─────────────────────── */
            :root {
                /* Background — base */
                --color-bg-primary: #FFFDF6;
                --color-bg-secondary: #F7F6ED;
                --color-bg-inverted: #100F0F;
                --color-bg-inverted-hovered: #282726;
                --color-bg-neutral-subtler: #E6E4D9;
                --color-bg-neutral-bold: #6F6E69;
                --color-bg-disabled: #E6E4D9;
                --color-bg-input: #F7F6ED;

                /* Background — selected */
                --color-bg-selected-bold: #205EA6;

                /* Background — accent */
                --color-bg-accent-orange-subtlest: #FFE7CE;
                --color-bg-accent-orange-subtler: #FED3AF;
                --color-bg-accent-orange-subtle: #F9AE77;
                --color-bg-accent-orange-bolder: #BC5215;
                --color-bg-accent-yellow-subtlest: #FAEEC6;
                --color-bg-accent-yellow-subtler: #F6E2A0;
                --color-bg-accent-yellow-subtle: #ECCB60;
                --color-bg-accent-yellow-bolder: #AD8301;
                --color-bg-accent-green-subtlest: #EDEECF;
                --color-bg-accent-green-subtler: #DDE2B2;
                --color-bg-accent-green-subtle: #BEC97E;
                --color-bg-accent-green-bolder: #66800B;
                --color-bg-accent-blue-subtlest: #E1ECEB;
                --color-bg-accent-blue-subtler: #C6DDE8;
                --color-bg-accent-blue-subtle: #92BFDB;
                --color-bg-accent-blue-bolder: #205EA6;
                --color-bg-accent-purple-subtlest: #F0EAEC;
                --color-bg-accent-purple-subtler: #E2D9E9;
                --color-bg-accent-purple-subtle: #C4B9E0;
                --color-bg-accent-purple-bolder: #5E409D;

                /* Background — success */
                --color-bg-success-bold: #66800B;
                --color-bg-success-bold-hovered: #536907;

                /* Text */
                --color-text-default: #100F0F;
                --color-text-subtle: #6F6E69;
                --color-text-subtlest: #B7B5AC;
                --color-text-disabled: #B7B5AC;
                --color-text-inverse: #FFFDF6;
                --color-text-selected: #205EA6;
                --color-text-information: #205EA6;
                --color-text-accent-green: #66800B;
                --color-text-accent-green-bolder: #536907;
                --color-text-accent-purple: #5E409D;
                --color-text-accent-yellow: #AD8301;
                --color-text-danger: #AF3029;

                /* Icon */
                --color-icon-normal: #100F0F;
                --color-icon-subtle: #6F6E69;
                --color-icon-subtlest: #B7B5AC;
                --color-icon-inverse: #FFFDF6;

                /* Border */
                --color-border-default: #DAD8CE;
                --color-border-bold: #B7B5AC;
                --color-border-boldest: #100F0F;
                --color-border-inverse: #FFFDF6;
                --color-border-input: #DAD8CE;
                --color-border-accent-green: #66800B;
                --color-border-accent-purple: #5E409D;
                --color-border-accent-yellow: #AD8301;
                --color-border-selected: #205EA6;

                /* Link */
                --color-link-default: #24837B;

                /* Elevation / surfaces */
                --color-elevation-surface: #FFFFFF;

                /* Opacity overlays */
                --color-overlay-scrim: rgba(255, 253, 246, 0.7);
                --color-overlay-blur-bg: rgba(255, 253, 246, 0.55);

                /* Shadows */
                --shadow-overlay: 0 2px 12px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.06);
                --shadow-card: 0 2px 12px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.06);
                --shadow-badge: 0 0 4px 0 rgba(0, 0, 0, 0.40);
                --shadow-toggle-knob: 0 1px 3px rgba(0,0,0,.15);
            }

            /* ─── Design tokens (dark mode) ──────────────────────── */
            html.dark {
                --color-bg-primary: #100F0F;
                --color-bg-secondary: #1C1B1A;
                --color-bg-inverted: #FFFDF6;
                --color-bg-inverted-hovered: #F7F6ED;
                --color-bg-neutral-subtler: #282726;
                --color-bg-neutral-bold: #B7B5AC;
                --color-bg-disabled: #343331;
                --color-bg-input: #1C1B1A;

                --color-bg-selected-bold: #4385BE;

                --color-bg-accent-orange-subtlest: #27180E;
                --color-bg-accent-orange-subtler: #40200D;
                --color-bg-accent-orange-subtle: #71320D;
                --color-bg-accent-orange-bolder: #EC8B49;
                --color-bg-accent-yellow-subtlest: #241E08;
                --color-bg-accent-yellow-subtler: #3A2D04;
                --color-bg-accent-yellow-subtle: #664D01;
                --color-bg-accent-yellow-bolder: #DFB431;
                --color-bg-accent-green-subtlest: #1A1E0C;
                --color-bg-accent-green-subtler: #252D09;
                --color-bg-accent-green-subtle: #3D4C07;
                --color-bg-accent-green-bolder: #A0AF54;
                --color-bg-accent-blue-subtlest: #101A24;
                --color-bg-accent-blue-subtler: #12253B;
                --color-bg-accent-blue-subtle: #163B66;
                --color-bg-accent-blue-bolder: #66A0C8;
                --color-bg-accent-purple-subtlest: #1A1623;
                --color-bg-accent-purple-subtler: #261C39;
                --color-bg-accent-purple-subtle: #3C2A62;
                --color-bg-accent-purple-bolder: #A699D0;

                --color-bg-success-bold: #A0AF54;
                --color-bg-success-bold-hovered: #BEC97E;

                --color-text-default: #CECDC3;
                --color-text-subtle: #878580;
                --color-text-subtlest: #575653;
                --color-text-disabled: #575653;
                --color-text-inverse: #100F0F;
                --color-text-selected: #66A0C8;
                --color-text-information: #66A0C8;
                --color-text-accent-green: #A0AF54;
                --color-text-accent-green-bolder: #BEC97E;
                --color-text-accent-purple: #A699D0;
                --color-text-accent-yellow: #DFB431;
                --color-text-danger: #D14D41;

                --color-icon-normal: #CECDC3;
                --color-icon-subtle: #878580;
                --color-icon-subtlest: #575653;
                --color-icon-inverse: #100F0F;

                --color-border-default: #343331;
                --color-border-bold: #6F6E69;
                --color-border-boldest: #CECDC3;
                --color-border-inverse: #100F0F;
                --color-border-input: #343331;
                --color-border-accent-green: #879A39;
                --color-border-accent-purple: #A699D0;
                --color-border-accent-yellow: #DFB431;
                --color-border-selected: #4385BE;

                --color-link-default: #3AA99F;

                --color-elevation-surface: #1C1B1A;

                --color-overlay-scrim: rgba(16, 15, 15, 0.7);
                --color-overlay-blur-bg: rgba(16, 15, 15, 0.55);

                --shadow-overlay: 0 2px 12px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.06);
                --shadow-card: 0 2px 12px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.06);
                --shadow-badge: 0 0 4px 0 rgba(0, 0, 0, 0.60);
                --shadow-toggle-knob: 0 1px 3px rgba(0,0,0,.3);
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            html,
            body,
            #root {
                height: 100%;
                width: 100%;
                overflow: hidden;
            }
            body {
                background: var(--color-bg-primary);
                color: var(--color-text-default);
                font-family: var(--body-font), sans-serif;
                -webkit-font-smoothing: antialiased;
                transition: background .3s ease, color .3s ease;
            }
            ::-webkit-scrollbar {
                width: 0;
                height: 0;
                background: transparent;
            }
            input, select, textarea, button {
                font-family: inherit;
                font-size: inherit;
                color: inherit;
            }

            /* ─── Explorer-specific styles ───────────────────────── */
            .result-row {
                transition: background .15s ease;
            }
            .result-row:hover {
                background: var(--color-bg-neutral-subtler);
            }
            .filter-pill {
                transition: background .15s ease, border-color .15s ease;
            }
            .filter-pill:hover {
                border-color: var(--color-border-bold);
            }
            /* ─── Floating cart overlay ─────────────────────────── */
            .cart-scrim {
                position: absolute;
                inset: 0;
                background: var(--color-bg-primary);
                opacity: 0;
                pointer-events: none;
                transition: opacity .3s ease;
                z-index: 19;
            }
            .cart-scrim.active {
                opacity: .55;
                pointer-events: auto;
            }
            .cart-overlay {
                position: absolute;
                bottom: 64px; left: 50%;
                transform: translateX(-50%);
                width: 764px;
                max-width: 90%;
                z-index: 20;
                display: flex;
                flex-direction: column;
                align-items: center;
                pointer-events: none;
                transition: opacity .3s ease;
            }
            .cart-overlay > * {
                pointer-events: auto;
            }
            /* ─ Drawer (narrower than bar, 16px inset each side) ─ */
            .cart-drawer {
                width: calc(100% - 32px);
                overflow: hidden;
                transition: max-height .25s cubic-bezier(.4, 0, .2, 1),
                            opacity .2s ease;
            }
            .cart-drawer.closed {
                max-height: 0;
                opacity: 0;
            }
            .cart-drawer.open {
                max-height: calc(100vh - 64px - 64px - 80px);
                opacity: 1;
            }
            .cart-card {
                background: var(--color-bg-primary);
                border: 1px solid var(--color-border-default);
                border-radius: 16px 16px 0 0;
                box-shadow: 0 2px 20px rgba(0,0,0,.04);
                padding: 24px 24px 32px;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            .cart-inner {
                background: var(--color-bg-secondary);
                border: 1px solid var(--color-border-default);
                border-radius: 12px;
                overflow: hidden;
            }
            .cart-card-scroll {
                max-height: calc(100vh - 64px - 64px - 200px);
                overflow-y: auto;
            }
            .cart-item {
                display: flex; align-items: center; gap: 32px;
                padding: 16px 20px;
                border-bottom: 1px solid var(--color-border-default);
            }
            .cart-item:last-child {
                border-bottom: none;
            }
            .cart-item:hover {
                background: var(--color-bg-neutral-subtler);
            }
            @keyframes cartItemIn {
                from { opacity: 0; transform: translateY(12px); }
                to   { opacity: 1; transform: translateY(0); }
            }
            /* ─ Blue bar ─ */
            .cart-bar {
                background: var(--color-bg-selected-bold);
                border-radius: 16px;
                width: 100%;
                transition: transform .3s cubic-bezier(.4, 0, .2, 1), opacity .3s ease;
            }
            .cart-bar.hidden {
                transform: translateY(100%);
                opacity: 0;
                pointer-events: none;
            }
            .selection-card {
                transition: background .15s ease;
            }
            .selection-card:hover {
                background: var(--color-bg-neutral-subtler);
            }
            .filter-dropdown {
                animation: dropdownIn .15s ease;
            }
            html.dark .filter-cat-icon {
                filter: invert(1);
            }
            @keyframes dropdownIn {
                from { opacity: 0; transform: translateY(-4px); }
                to   { opacity: 1; transform: translateY(0); }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
        <script>
            window.onerror = function (msg, url, line, col, err) {
                var d = document.createElement("div");
                d.style.cssText =
                    "position:fixed;top:0;left:0;right:0;z-index:99999;background:#fee;color:#900;padding:16px;font:14px monospace;white-space:pre-wrap;max-height:40vh;overflow:auto";
                d.textContent =
                    "ERROR: " + msg + "\nLine: " + line + ", Col: " + col +
                    (err && err.stack ? "\n\nStack:\n" + err.stack : "");
                document.body.prepend(d);
            };
        </script>
        <script>
            (function () {
                document.documentElement.classList.remove("dark");
            })();
        </script>
        <script type="text/babel" data-type="module">
            const { useState, useEffect, useRef, useCallback, useMemo } = React;

            /* ─── Dummy data ──────────────────────────────────────── */
            const ITEMS = [
                // ── Montreal: Downtown / Ville-Marie ──
                { id: 1,  name: "Montreal Museum of Fine Arts",  category: "Cultural Attraction", type: "POI",      region: "Downtown",    tags: ["Museum"],       lat: 45.4985, lng: -73.5793 },
                { id: 2,  name: "Place des Arts",                category: "Cultural Attraction", type: "POI",      region: "Downtown",    tags: ["Arts"],         lat: 45.5081, lng: -73.5664 },
                { id: 3,  name: "McCord Stewart Museum",         category: "Cultural Attraction", type: "POI",      region: "Downtown",    tags: ["Museum"],       lat: 45.5040, lng: -73.5736 },
                { id: 4,  name: "Basilique Notre-Dame",          category: "Cultural Attraction", type: "POI",      region: "Old Montreal", tags: ["Historic"],    lat: 45.5046, lng: -73.5566 },
                { id: 5,  name: "Bonsecours Market",             category: "Cultural Attraction", type: "POI",      region: "Old Montreal", tags: ["Historic"],    lat: 45.5087, lng: -73.5520 },
                { id: 6,  name: "Cardinal Café",                 category: "Food & Beverage",     subcategory: "Café",             type: "Business", region: "Downtown",    tags: ["Coffee"],       lat: 45.5025, lng: -73.5717 },
                { id: 7,  name: "Dunya",                         category: "Food & Beverage",     subcategory: "Middle Eastern",   type: "Business", region: "Downtown",    tags: ["Middle Eastern"], lat: 45.5063, lng: -73.5680 },
                { id: 8,  name: "Chez Laurent",                  category: "Food & Beverage",     subcategory: "French",           type: "Business", region: "Downtown",    tags: ["French"],       lat: 45.5010, lng: -73.5759 },
                { id: 9,  name: "Maison Boulud",                 category: "Food & Beverage",     subcategory: "Fine Dining",      type: "Business", region: "Downtown",    tags: ["Fine Dining"],  lat: 45.5005, lng: -73.5729 },
                { id: 10, name: "Hôtel Birks",                   category: "Accommodation",       type: "Business", region: "Downtown",    tags: ["Luxury"],       lat: 45.5020, lng: -73.5735 },
                // ── Plateau Mont-Royal ──
                { id: 11, name: "Le Plateau Bistro",             category: "Food & Beverage",     subcategory: "Brunch & Breakfast", type: "Business", region: "Plateau",     tags: ["Brunch"],       lat: 45.5225, lng: -73.5776 },
                { id: 12, name: "Schwartz's Deli",               category: "Food & Beverage",     subcategory: "Deli & Smoked Meat", type: "Business", region: "Plateau",     tags: ["Iconic"],       lat: 45.5189, lng: -73.5774 },
                { id: 13, name: "Beauty's Luncheonette",         category: "Food & Beverage",     subcategory: "Brunch & Breakfast", type: "Business", region: "Plateau",     tags: ["Brunch"],       lat: 45.5208, lng: -73.5850 },
                { id: 14, name: "Librairie Drawn & Quarterly",   category: "Retail",              type: "Business", region: "Plateau",     tags: ["Books"],        lat: 45.5256, lng: -73.5851 },
                { id: 15, name: "Parc La Fontaine",              category: "Provincial Park",     type: "POI",      region: "Plateau",     tags: ["Park"],         lat: 45.5283, lng: -73.5689 },
                { id: 16, name: "Tam-Tams du Mont Royal",        category: "Cultural Attraction", type: "POI",      region: "Plateau",     tags: ["Music"],        lat: 45.5155, lng: -73.5878 },
                // ── Mile End / Mile-Ex ──
                { id: 17, name: "Fairmount Bagel",               category: "Food & Beverage",     subcategory: "Bakery & Bagels",  type: "Business", region: "Mile End",    tags: ["Iconic"],       lat: 45.5244, lng: -73.5974 },
                { id: 18, name: "St-Viateur Bagel",              category: "Food & Beverage",     subcategory: "Bakery & Bagels",  type: "Business", region: "Mile End",    tags: ["Iconic"],       lat: 45.5233, lng: -73.6012 },
                { id: 19, name: "Dieu du Ciel!",                 category: "Food & Beverage",     subcategory: "Bar & Brewery",    type: "Business", region: "Mile End",    tags: ["Brewery"],      lat: 45.5275, lng: -73.5976 },
                { id: 20, name: "Marché Jean-Talon",             category: "Retail",              type: "POI",      region: "Mile End",    tags: ["Market"],       lat: 45.5372, lng: -73.6146 },
                { id: 21, name: "Club Social",                   category: "Food & Beverage",     subcategory: "Café",             type: "Business", region: "Mile End",    tags: ["Coffee"],       lat: 45.5213, lng: -73.5979 },
                // ── Old Montreal ──
                { id: 22, name: "Science Centre",                category: "Cultural Attraction", type: "POI",      region: "Old Montreal", tags: ["Museum"],      lat: 45.5055, lng: -73.5523 },
                { id: 23, name: "Clock Tower",                   category: "Cultural Attraction", type: "POI",      region: "Old Montreal", tags: ["Historic"],    lat: 45.5104, lng: -73.5464 },
                { id: 24, name: "Old Port Skating Rink",         category: "Cultural Attraction", type: "POI",      region: "Old Montreal", tags: ["Sports"],      lat: 45.5048, lng: -73.5539 },
                { id: 25, name: "Olive et Gourmando",            category: "Food & Beverage",     subcategory: "Brunch & Breakfast", type: "Business", region: "Old Montreal", tags: ["Brunch"],      lat: 45.5030, lng: -73.5568 },
                { id: 26, name: "Le Petit Dep",                  category: "Food & Beverage",     subcategory: "Café",             type: "Business", region: "Old Montreal", tags: ["Coffee"],      lat: 45.5041, lng: -73.5541 },
                { id: 27, name: "Auberge du Vieux-Port",         category: "Accommodation",       type: "Business", region: "Old Montreal", tags: ["Boutique"],    lat: 45.5068, lng: -73.5505 },
                // ── Griffintown / Saint-Henri ──
                { id: 28, name: "Joe Beef",                      category: "Food & Beverage",     subcategory: "Fine Dining",      type: "Business", region: "Griffintown",  tags: ["Fine Dining"], lat: 45.4830, lng: -73.5784 },
                { id: 29, name: "Atwater Market",                category: "Retail",              type: "POI",      region: "Griffintown",  tags: ["Market"],      lat: 45.4829, lng: -73.5845 },
                { id: 30, name: "Lachine Canal Path",            category: "Provincial Park",     type: "POI",      region: "Griffintown",  tags: ["Cycling"],     lat: 45.4815, lng: -73.5735 },
                { id: 31, name: "Canal Lounge",                  category: "Food & Beverage",     subcategory: "Bar & Brewery",    type: "Business", region: "Griffintown",  tags: ["Bar"],         lat: 45.4870, lng: -73.5677 },
                { id: 32, name: "Rustique Pie Kitchen",          category: "Food & Beverage",     subcategory: "Bakery & Bagels",  type: "Business", region: "Griffintown",  tags: ["Bakery"],      lat: 45.4847, lng: -73.5712 },
                // ── Mont Royal / Outremont ──
                { id: 33, name: "Mont Royal Summit",             category: "Provincial Park",     type: "POI",      region: "Mont Royal",   tags: ["Park", "Hiking"], lat: 45.5045, lng: -73.5878 },
                { id: 34, name: "Beaver Lake",                   category: "Provincial Park",     type: "POI",      region: "Mont Royal",   tags: ["Park"],        lat: 45.4993, lng: -73.5962 },
                { id: 35, name: "Smith House",                   category: "Cultural Attraction", type: "POI",      region: "Mont Royal",   tags: ["Historic"],    lat: 45.5036, lng: -73.5896 },
                { id: 36, name: "Oratoire Saint-Joseph",         category: "Cultural Attraction", type: "POI",      region: "Mont Royal",   tags: ["Historic"],    lat: 45.4917, lng: -73.6170 },
                { id: 37, name: "Leméac",                        category: "Food & Beverage",     subcategory: "French",           type: "Business", region: "Mont Royal",   tags: ["French"],      lat: 45.5167, lng: -73.6070 },
                // ── Hochelaga / East End ──
                { id: 38, name: "Jardin Botanique",              category: "Provincial Park",     type: "POI",      region: "Hochelaga",    tags: ["Park"],        lat: 45.5576, lng: -73.5625 },
                { id: 39, name: "Biodome",                       category: "Cultural Attraction", type: "POI",      region: "Hochelaga",    tags: ["Museum"],      lat: 45.5599, lng: -73.5508 },
                { id: 40, name: "Olympic Stadium",               category: "Cultural Attraction", type: "POI",      region: "Hochelaga",    tags: ["Sports", "Iconic"], lat: 45.5579, lng: -73.5516 },
                { id: 41, name: "Insectarium",                   category: "Cultural Attraction", type: "POI",      region: "Hochelaga",    tags: ["Museum"],      lat: 45.5568, lng: -73.5587 },
                { id: 42, name: "Café Dispatch",                 category: "Food & Beverage",     subcategory: "Café",             type: "Business", region: "Hochelaga",    tags: ["Coffee"],      lat: 45.5415, lng: -73.5450 },
                // ── Verdun / South Shore ──
                { id: 43, name: "Verdun Beach",                  category: "Provincial Park",     type: "POI",      region: "Verdun",       tags: ["Park"],        lat: 45.4600, lng: -73.5670 },
                { id: 44, name: "Wellington Street Shops",        category: "Retail",              type: "Business", region: "Verdun",       tags: ["Shopping"],    lat: 45.4590, lng: -73.5720 },
                { id: 45, name: "Palco",                         category: "Food & Beverage",     subcategory: "Bar & Brewery",    type: "Business", region: "Verdun",       tags: ["Bar"],         lat: 45.4596, lng: -73.5694 },
                // ── Rosemont / Petite-Patrie ──
                { id: 46, name: "Marché de la Petite-Patrie",    category: "Retail",              type: "POI",      region: "Rosemont",     tags: ["Market"],      lat: 45.5345, lng: -73.6050 },
                { id: 47, name: "Hôtel Le Germain",              category: "Accommodation",       type: "Business", region: "Downtown",     tags: ["Boutique"],    lat: 45.5015, lng: -73.5700 },
                { id: 48, name: "Auberge Bishop",                category: "Accommodation",       type: "Business", region: "Downtown",     tags: ["Budget"],      lat: 45.4980, lng: -73.5730 },
                { id: 49, name: "Gîte du Plateau",               category: "Accommodation",       type: "Business", region: "Plateau",      tags: ["B&B"],         lat: 45.5240, lng: -73.5815 },
                { id: 50, name: "La Pêche Fraîche",              category: "Food & Beverage",     subcategory: "Seafood",          type: "Business", region: "Rosemont",     tags: ["Seafood"],     lat: 45.5380, lng: -73.5920 },
            ];

            /* ─── Region boundaries (closed polygons, [lng, lat]) ── */
            const REGION_BOUNDARIES = {
                "Downtown": [
                    [-73.5830, 45.5100], [-73.5830, 45.4960], [-73.5620, 45.4960],
                    [-73.5620, 45.5100], [-73.5830, 45.5100],
                ],
                "Old Montreal": [
                    [-73.5600, 45.5110], [-73.5600, 45.5015], [-73.5430, 45.5015],
                    [-73.5430, 45.5110], [-73.5600, 45.5110],
                ],
                "Plateau": [
                    [-73.5910, 45.5310], [-73.5910, 45.5140], [-73.5650, 45.5140],
                    [-73.5650, 45.5310], [-73.5910, 45.5310],
                ],
                "Mile End": [
                    [-73.6180, 45.5400], [-73.6180, 45.5200], [-73.5930, 45.5200],
                    [-73.5930, 45.5400], [-73.6180, 45.5400],
                ],
                "Griffintown": [
                    [-73.5880, 45.4900], [-73.5880, 45.4790], [-73.5640, 45.4790],
                    [-73.5640, 45.4900], [-73.5880, 45.4900],
                ],
                "Mont Royal": [
                    [-73.6210, 45.5080], [-73.6210, 45.4880], [-73.5830, 45.4880],
                    [-73.5830, 45.5080], [-73.6210, 45.5080],
                ],
                "Hochelaga": [
                    [-73.5650, 45.5620], [-73.5650, 45.5380], [-73.5400, 45.5380],
                    [-73.5400, 45.5620], [-73.5650, 45.5620],
                ],
                "Verdun": [
                    [-73.5770, 45.4650], [-73.5770, 45.4550], [-73.5620, 45.4550],
                    [-73.5620, 45.4650], [-73.5770, 45.4650],
                ],
                "Rosemont": [
                    [-73.6100, 45.5420], [-73.6100, 45.5300], [-73.5870, 45.5300],
                    [-73.5870, 45.5420], [-73.6100, 45.5420],
                ],
            };

            /* ─── Filter category hierarchy ─────────────────────── */
            const FILTER_CATEGORIES = [
                {
                    id: "category",
                    label: "Business Type",
                    icon: "assets/home-alt.svg",
                    field: "category",
                    rules: ["is", "is not"],
                    options: (() => {
                        const cats = [...new Set(ITEMS.map(i => i.category))].sort();
                        return cats.map(c => {
                            /* build children from subcategory field if present */
                            const subs = [...new Set(
                                ITEMS.filter(i => i.category === c && i.subcategory)
                                     .map(i => i.subcategory)
                            )].sort();
                            return subs.length > 0
                                ? { id: c, label: c, children: subs }
                                : { id: c, label: c };
                        });
                    })(),
                },
                {
                    id: "region",
                    label: "Region",
                    icon: "assets/map.svg",
                    field: "region",
                    rules: ["is", "is not"],
                    options: [...new Set(ITEMS.map(i => i.region))].sort().map(r => ({ id: r, label: r })),
                },
                {
                    id: "tags",
                    label: "Custom Tags",
                    icon: "assets/label.svg",
                    field: "tags",
                    rules: ["is", "is not"],
                    options: [...new Set(ITEMS.flatMap(i => i.tags))].filter(Boolean).sort().map(t => ({ id: t, label: t })),
                },
            ];

            /* helpers for filter logic */
            function flattenSelections(selected, category) {
                const vals = [];
                for (const [optId, sel] of Object.entries(selected)) {
                    const opt = category.options.find(o => o.id === optId);
                    if (!opt) continue;
                    if (opt.children && opt.children.length > 0) {
                        if (sel === "all") {
                            /* parent fully selected → match by parent category */
                            vals.push(optId);
                        } else if (sel instanceof Set || (typeof sel === "object" && sel.size !== undefined)) {
                            vals.push(...sel);
                        } else if (Array.isArray(sel)) {
                            vals.push(...sel);
                        }
                    } else {
                        vals.push(optId);
                    }
                }
                return vals;
            }

            function matchesFilter(item, field, selectedValues) {
                if (field === "tags") return item.tags.some(t => selectedValues.includes(t));
                /* check primary field (e.g. category) and subcategory */
                return selectedValues.includes(item[field])
                    || (item.subcategory && selectedValues.includes(item.subcategory));
            }

            function getFieldValue(item, field) {
                if (field === "tags") return item.tags && item.tags.length > 0 ? item.tags.join(",") : "";
                return item[field] || "";
            }

            /* ─── Type color mapping ──────────────────────────────── */
            const TYPE_COLORS = {
                Business: { bg: "var(--color-bg-accent-orange-subtlest)", border: "var(--color-bg-accent-orange-subtle)", text: "var(--color-bg-accent-orange-bolder)" },
                POI:      { bg: "var(--color-bg-accent-green-subtlest)",  border: "var(--color-bg-accent-green-subtle)",  text: "var(--color-bg-accent-green-bolder)" },
            };

            /* Map "Provincial Park" type to "Area" for dot colors */
            const getItemType = (item) => {
                if (item.category === "Provincial Park") return "Area";
                return item.type;
            };

            /* ─── SVG Icons ───────────────────────────────────────── */
            const Icon = ({ name, size = 16, color = "currentColor" }) => {
                const icons = {
                    search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                    chevronDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
                    plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                    x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                    check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                    sun: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
                    moon: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
                    "circle-x": <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
                    "arrow-right": <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
                    "arrow-left": <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
                    "chevron-right": <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 6 15 12 9 18"/></svg>,
                    minus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                };
                return icons[name] || null;
            };

            /* ─── Checkbox ────────────────────────────────────────── */
            function Checkbox({ checked, indeterminate, onChange, size = 18 }) {
                const filled = checked || indeterminate;
                return (
                    <div onClick={e => { e.stopPropagation(); onChange(!checked); }} style={{
                        width: size, height: size, borderRadius: 4, cursor: "pointer",
                        border: filled ? "none" : "1.5px solid var(--color-border-bold)",
                        background: filled ? "var(--color-bg-selected-bold)" : "transparent",
                        display: "flex", alignItems: "center", justifyContent: "center",
                        transition: "background .15s ease, border .15s ease",
                        flexShrink: 0,
                    }}>
                        {indeterminate && <Icon name="minus" size={12} color="var(--color-text-inverse)" />}
                        {checked && !indeterminate && <Icon name="check" size={12} color="var(--color-text-inverse)" />}
                    </div>
                );
            }

            /* ─── SearchBar ───────────────────────────────────────── */
            function SearchBar({ value, onChange }) {
                return (
                    <div style={{
                        display: "flex", alignItems: "center", gap: 8,
                        border: "2px solid var(--color-border-selected)",
                        borderImage: "none",
                        borderRadius: 8, padding: "10px 16px",
                        background: "var(--color-bg-secondary)",
                    }}>
                        <input
                            type="text"
                            placeholder="Search..."
                            value={value}
                            onChange={e => onChange(e.target.value)}
                            style={{
                                flex: 1, border: "none", outline: "none",
                                background: "transparent", fontSize: 14,
                                color: "var(--color-text-default)",
                            }}
                        />
                        <span style={{
                            fontSize: 13, fontWeight: 500,
                            color: "var(--color-text-selected)",
                            whiteSpace: "nowrap", cursor: "pointer",
                            display: "flex", alignItems: "center", gap: 2,
                        }}>
                            within my account
                            <Icon name="chevronDown" size={14} color="var(--color-text-selected)" />
                        </span>
                    </div>
                );
            }

            /* ─── Type dot colors (for legend + row indicators) ──── */
            const TYPE_DOT = {
                Business: "#d0a215",
                POI:      "#8b7ec8",
                Area:     "#3aa99f",
            };
            /* darker variants for map markers/labels in light mode */
            const TYPE_MAP = {
                Business: "#a07a0e",
                POI:      "#6b5da6",
                Area:     "#2d847c",
            };

            /* ─── Filter popover search input ─────────────────────── */
            function FilterSearch({ value, onChange, placeholder = "Search..." }) {
                return (
                    <div style={{
                        display: "flex", alignItems: "center", gap: 8,
                        background: "var(--color-bg-secondary)",
                        border: "1px solid var(--color-border-default)",
                        borderRadius: 8, padding: "8px 12px",
                    }}>
                        <Icon name="search" size={16} color="var(--color-icon-subtle)" />
                        <input value={value} onChange={e => onChange(e.target.value)}
                            placeholder={placeholder}
                            style={{
                                flex: 1, border: "none", outline: "none", fontSize: 14,
                                background: "transparent", color: "var(--color-text-default)",
                                fontFamily: "inherit",
                            }}
                        />
                    </div>
                );
            }

            /* ─── RuleDropdown ────────────────────────────────────── */
            function RuleDropdown({ rules, current, onSelect, onClose }) {
                const ref = useRef(null);
                useEffect(() => {
                    const handler = (e) => { if (ref.current && !ref.current.contains(e.target)) onClose(); };
                    document.addEventListener("mousedown", handler);
                    return () => document.removeEventListener("mousedown", handler);
                }, [onClose]);
                return (
                    <div ref={ref} className="filter-dropdown" style={{
                        position: "absolute", top: "calc(100% + 4px)", left: 0, zIndex: 30,
                        background: "var(--color-bg-secondary)", borderRadius: 8,
                        boxShadow: "var(--shadow-overlay)", minWidth: 160,
                        border: "1px solid var(--color-border-default)", padding: 4,
                    }}>
                        {rules.map(r => (
                            <div key={r} onClick={() => { onSelect(r); onClose(); }} style={{
                                padding: "8px 12px", cursor: "pointer", fontSize: 14, fontWeight: 400,
                                color: "var(--color-text-default)", borderRadius: 6,
                                transition: "background .1s",
                                textTransform: "capitalize",
                            }}
                            onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-tertiary)"}
                            onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                {r.charAt(0).toUpperCase() + r.slice(1)}
                            </div>
                        ))}
                    </div>
                );
            }

            /* ─── FilterPopover ───────────────────────────────────── */
            function FilterPopover({ isOpen, onClose, filter, categoryId, onSave, onDelete }) {
                /*
                 * Draft-then-save model: selections are local until Save is clicked.
                 * filter = existing filter object (editing) or null (creating new).
                 */
                const [screen, setScreen] = useState("categories");
                const [activeCatId, setActiveCatId] = useState(null);
                const [activeOptId, setActiveOptId] = useState(null);
                const [catSearch, setCatSearch] = useState("");
                const [foSearch, setFoSearch] = useState("");
                const [soSearch, setSoSearch] = useState("");
                const [showRuleMenu, setShowRuleMenu] = useState(false);
                const [draftSelected, setDraftSelected] = useState({});
                const [draftRule, setDraftRule] = useState("is");
                const popRef = useRef(null);

                const isEditing = !!filter;

                /* reset navigation + draft when the popover first opens */
                const prevOpenRef = useRef(false);
                useEffect(() => {
                    if (isOpen && !prevOpenRef.current) {
                        if (categoryId) {
                            setActiveCatId(categoryId);
                            setScreen("first-order");
                        } else {
                            setScreen("categories");
                            setActiveCatId(null);
                        }
                        setActiveOptId(null);
                        setCatSearch(""); setFoSearch(""); setSoSearch("");
                        setShowRuleMenu(false);
                        /* initialise draft from existing filter or blank */
                        setDraftSelected(filter ? { ...filter.selected } : {});
                        setDraftRule(filter ? filter.rule : "is");
                    }
                    prevOpenRef.current = isOpen;
                }, [isOpen, categoryId]);

                /* close on outside click */
                useEffect(() => {
                    if (!isOpen) return;
                    const handler = (e) => {
                        if (popRef.current && !popRef.current.contains(e.target)) onClose();
                    };
                    document.addEventListener("mousedown", handler);
                    return () => document.removeEventListener("mousedown", handler);
                }, [isOpen, onClose]);

                /* clamp popover inside the explorer panel (horizontal + vertical) */
                const [nudge, setNudge] = useState(0);
                const [maxH, setMaxH] = useState(600);
                useEffect(() => {
                    if (!isOpen) { setNudge(0); setMaxH(600); return; }
                    const id = requestAnimationFrame(() => {
                        if (!popRef.current) return;
                        const el = popRef.current;
                        const margin = 12;
                        /* horizontal clamping */
                        el.style.left = "0px";
                        const pop = el.getBoundingClientRect();
                        let panel = el.parentElement;
                        while (panel && panel.offsetWidth < 500) panel = panel.parentElement;
                        if (!panel) return;
                        const panelRect = panel.getBoundingClientRect();
                        let shift = 0;
                        if (pop.right > panelRect.right - margin) shift = panelRect.right - margin - pop.right;
                        if (pop.left + shift < panelRect.left + margin) shift = panelRect.left + margin - pop.left;
                        el.style.left = shift + "px";
                        setNudge(shift);
                        /* vertical clamping — cap height so footer stays on-screen */
                        const available = window.innerHeight - pop.top - margin;
                        setMaxH(Math.max(200, available));
                    });
                    return () => cancelAnimationFrame(id);
                });

                if (!isOpen) return null;

                const activeCat = FILTER_CATEGORIES.find(c => c.id === activeCatId);
                const activeOpt = activeCat ? activeCat.options.find(o => o.id === activeOptId) : null;

                /* ── draft validity (is Save enabled?) ── */
                const draftHasSelections = Object.keys(draftSelected).length > 0;
                const canSave = screen !== "categories" && (
                    draftRule === "is empty" || draftRule === "is not empty" || draftHasSelections
                );

                /* ── selection helpers (operate on draft) ── */
                const isFirstOrderChecked = (optId) => !!draftSelected[optId];
                const isFirstOrderIndeterminate = (optId) => {
                    const sel = draftSelected[optId];
                    if (!sel) return false;
                    const opt = activeCat.options.find(o => o.id === optId);
                    if (!opt || !opt.children || opt.children.length === 0) return false;
                    return sel !== "all" && sel.size < opt.children.length;
                };

                const toggleFirstOrder = (optId) => {
                    setDraftSelected(prev => {
                        const next = { ...prev };
                        if (next[optId]) delete next[optId]; else next[optId] = "all";
                        return next;
                    });
                };

                const isSecondOrderChecked = (childId) => {
                    const sel = draftSelected[activeOptId];
                    if (!sel) return false;
                    if (sel === "all") return true;
                    return sel.has(childId);
                };

                const toggleSecondOrder = (childId) => {
                    setDraftSelected(prev => {
                        const next = { ...prev };
                        const opt = activeCat.options.find(o => o.id === activeOptId);
                        const children = opt ? opt.children : [];
                        let current = next[activeOptId];
                        if (!current) {
                            next[activeOptId] = new Set([childId]);
                        } else if (current === "all") {
                            const s = new Set(children);
                            s.delete(childId);
                            if (s.size === 0) delete next[activeOptId]; else next[activeOptId] = s;
                        } else {
                            const s = new Set(current);
                            if (s.has(childId)) s.delete(childId); else s.add(childId);
                            if (s.size === 0) delete next[activeOptId];
                            else if (s.size === children.length) next[activeOptId] = "all";
                            else next[activeOptId] = s;
                        }
                        return next;
                    });
                };

                const handleSave = () => {
                    if (!canSave) return;
                    onSave(activeCatId, draftRule, draftSelected);
                    onClose();
                };

                const handleDelete = () => {
                    onDelete(activeCatId);
                    onClose();
                };

                /* shared styles */
                const itemRowStyle = {
                    display: "flex", alignItems: "center", gap: 12, padding: 8,
                    borderRadius: 6, cursor: "pointer", transition: "background .1s",
                };
                const footerStyle = {
                    display: "flex", alignItems: "center", justifyContent: "space-between",
                    padding: "12px 20px", borderTop: "1px solid var(--color-border-default)",
                    background: "var(--color-bg-secondary)", flexShrink: 0,
                };
                const footerTextBase = { fontSize: 14, fontWeight: 500, cursor: "pointer" };

                /* ─── Footer bar ─── */
                const footer = (
                    <div style={footerStyle}>
                        <span onClick={onClose}
                            style={{ ...footerTextBase, color: "var(--color-text-subtlest)" }}>Cancel</span>
                        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                            {isEditing && (
                                <span onClick={handleDelete}
                                    style={{ ...footerTextBase, color: "var(--color-text-danger)" }}>Delete</span>
                            )}
                            <span onClick={canSave ? handleSave : undefined}
                                style={{
                                    ...footerTextBase,
                                    color: "var(--color-text-information)",
                                    opacity: canSave ? 1 : 0.35,
                                    cursor: canSave ? "pointer" : "default",
                                }}>Save</span>
                        </div>
                    </div>
                );

                /* ═══ RENDER ═══ */
                return (
                    <div ref={popRef} className="filter-dropdown" style={{
                        position: "absolute", top: "calc(100% + 4px)", left: nudge, zIndex: 25,
                        width: 380, background: "var(--color-bg-primary)",
                        borderRadius: 12, boxShadow: "var(--shadow-overlay)",
                        border: "1px solid var(--color-border-default)",
                        overflow: "hidden", display: "flex", flexDirection: "column",
                        maxHeight: maxH,
                    }}>
                        {/* ─── SCREEN: Categories ─── */}
                        {screen === "categories" && (
                            <>
                                <div style={{
                                    display: "flex", alignItems: "center", padding: "0 20px", height: 48,
                                    borderBottom: "1px solid var(--color-border-default)", flexShrink: 0,
                                }}>
                                    <span style={{ fontSize: 14, fontWeight: 600, color: "var(--color-text-default)" }}>Filter by...</span>
                                </div>
                                <div style={{ padding: "24px 20px", display: "flex", flexDirection: "column", gap: 12, overflowY: "auto", flex: 1 }}>
                                    <FilterSearch value={catSearch} onChange={setCatSearch} />
                                    <div style={{ display: "flex", flexDirection: "column" }}>
                                        {FILTER_CATEGORIES
                                            .filter(c => c.label.toLowerCase().includes(catSearch.toLowerCase()))
                                            .map(cat => (
                                                <div key={cat.id} onClick={() => {
                                                    setActiveCatId(cat.id);
                                                    setScreen("first-order");
                                                    setFoSearch("");
                                                }} style={{ ...itemRowStyle, gap: 8 }}
                                                onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                                onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                                    <span style={{ fontSize: 14, fontWeight: 500, color: "var(--color-text-default)" }}>{cat.label}</span>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                                {footer}
                            </>
                        )}

                        {/* ─── SCREEN: First-order ─── */}
                        {screen === "first-order" && activeCat && (
                            <>
                                <div style={{
                                    display: "flex", alignItems: "center", padding: "0 20px", height: 48,
                                    borderBottom: "1px solid var(--color-border-default)", flexShrink: 0,
                                }}>
                                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                        <span style={{ fontSize: 14, fontWeight: 600, color: "var(--color-text-default)" }}>{activeCat.label}</span>
                                        <div style={{ position: "relative" }}>
                                            <div onClick={() => setShowRuleMenu(!showRuleMenu)} style={{
                                                display: "inline-flex", alignItems: "center", gap: 4,
                                                padding: "1px 8px", borderRadius: 4, cursor: "pointer",
                                                background: "var(--color-bg-accent-blue-subtlest)",
                                                border: "1px solid var(--color-bg-accent-blue-subtle)",
                                            }}>
                                                <span style={{ fontSize: 14, fontWeight: 600, color: "var(--color-text-selected)" }}>{draftRule}</span>
                                                <Icon name="chevronDown" size={14} color="var(--color-text-selected)" />
                                            </div>
                                            {showRuleMenu && (
                                                <RuleDropdown
                                                    rules={activeCat.rules}
                                                    current={draftRule}
                                                    onSelect={(r) => { setDraftRule(r); setShowRuleMenu(false); }}
                                                    onClose={() => setShowRuleMenu(false)}
                                                />
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div style={{ padding: "24px 20px", display: "flex", flexDirection: "column", gap: 12, overflowY: "auto", flex: 1 }}>
                                    <FilterSearch value={foSearch} onChange={setFoSearch} />
                                    <div style={{ display: "flex", flexDirection: "column" }}>
                                        {activeCat.options
                                            .filter(o => o.label.toLowerCase().includes(foSearch.toLowerCase()))
                                            .map(opt => {
                                                const checked = isFirstOrderChecked(opt.id);
                                                const indeterminate = isFirstOrderIndeterminate(opt.id);
                                                const hasChildren = opt.children && opt.children.length > 0;
                                                return (
                                                    <div key={opt.id} style={{ ...itemRowStyle, cursor: hasChildren ? "pointer" : "default" }}
                                                        onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                                        onMouseLeave={e => e.currentTarget.style.background = "transparent"}
                                                        onClick={hasChildren ? () => {
                                                            setActiveOptId(opt.id);
                                                            setScreen("second-order");
                                                            setSoSearch("");
                                                        } : undefined}>
                                                        <Checkbox checked={checked && !indeterminate} indeterminate={indeterminate}
                                                            onChange={() => toggleFirstOrder(opt.id)} size={20} />
                                                        <span style={{
                                                            flex: 1, fontSize: 14, fontWeight: 500,
                                                            color: "var(--color-text-default)", minWidth: 0,
                                                            overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap",
                                                        }}>{opt.label}</span>
                                                        {hasChildren && (
                                                            <div style={{
                                                                display: "flex", alignItems: "center",
                                                                color: "var(--color-icon-subtle)",
                                                                padding: "2px",
                                                            }}>
                                                                <Icon name="chevron-right" size={16} />
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                    </div>
                                </div>
                                {footer}
                            </>
                        )}

                        {/* ─── SCREEN: Second-order ─── */}
                        {screen === "second-order" && activeCat && activeOpt && (
                            <>
                                <div style={{
                                    display: "flex", alignItems: "center", padding: "0 20px", height: 48,
                                    borderBottom: "1px solid var(--color-border-default)", flexShrink: 0,
                                }}>
                                    <button onClick={() => { setScreen("first-order"); setActiveOptId(null); }} style={{
                                        display: "inline-flex", alignItems: "center", gap: 6,
                                        padding: 0, cursor: "pointer",
                                        border: "none",
                                        background: "none", fontSize: 14,
                                        fontWeight: 500, color: "var(--color-text-default)",
                                    }}>
                                        <Icon name="arrow-left" size={14} /> Back
                                    </button>
                                </div>
                                <div style={{ padding: "24px 20px", display: "flex", flexDirection: "column", gap: 12, overflowY: "auto", flex: 1 }}>
                                    <FilterSearch value={soSearch} onChange={setSoSearch} />
                                    <div style={{ display: "flex", flexDirection: "column" }}>
                                        {activeOpt.children
                                            .filter(c => c.toLowerCase().includes(soSearch.toLowerCase()))
                                            .map(child => (
                                                <div key={child} style={{ ...itemRowStyle, cursor: "default" }}
                                                    onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                                    onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                                    <Checkbox checked={isSecondOrderChecked(child)}
                                                        onChange={() => toggleSecondOrder(child)} size={20} />
                                                    <span style={{ fontSize: 14, fontWeight: 500, color: "var(--color-text-default)" }}>{child}</span>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                                {footer}
                            </>
                        )}
                    </div>
                );
            }

            /* ─── format pill label ───────────────────────────────── */
            function formatFilterLabel(filter) {
                const cat = FILTER_CATEGORIES.find(c => c.id === filter.categoryId);
                const label = cat ? cat.label : filter.categoryId;
                if (filter.rule === "is empty") return `${label}: empty`;
                if (filter.rule === "is not empty") return `${label}: not empty`;
                const keys = Object.keys(filter.selected);
                if (keys.length === 0) return label;
                const rulePrefix = filter.rule === "is not" ? "not " : "";
                /* expand parents with children into their individual sub-names */
                const allNames = [];
                for (const optId of keys) {
                    const opt = cat ? cat.options.find(o => o.id === optId) : null;
                    const sel = filter.selected[optId];
                    if (opt && opt.children && opt.children.length > 0 && sel !== "all") {
                        /* partially selected — show child names */
                        const childNames = sel instanceof Set ? [...sel] : Array.isArray(sel) ? sel : [];
                        allNames.push(...childNames);
                    } else {
                        allNames.push(optId);
                    }
                }
                const display = allNames.slice(0, 3).join(", ");
                const overflow = allNames.length > 3 ? ` +${allNames.length - 3}` : "";
                return `${label}: ${rulePrefix}${display}${overflow}`;
            }

            /* ─── FilterBar ───────────────────────────────────────── */
            function FilterBar({ filters, onUpdateFilter, onRemoveFilter }) {
                const [popoverOpen, setPopoverOpen] = useState(false);
                const [editingCatId, setEditingCatId] = useState(null);

                /* find the filter for the currently-open category */
                const editingFilter = editingCatId ? filters.find(f => f.categoryId === editingCatId) : null;

                const handleSave = (categoryId, rule, selected) => {
                    onUpdateFilter(categoryId, rule, selected);
                };

                const handleDelete = (categoryId) => {
                    onRemoveFilter(categoryId);
                };

                const closePopover = () => { setPopoverOpen(false); setEditingCatId(null); };

                const openNew = () => {
                    setEditingCatId(null);
                    setPopoverOpen(true);
                };

                const openEdit = (catId) => {
                    setEditingCatId(catId);
                    setPopoverOpen(true);
                };

                /* decide where to anchor the popover:
                   – if editing a category that has a pill → render inside that pill wrapper
                   – otherwise (new filter, no pill yet) → render inside the add-button wrapper */
                const popoverOnPill = popoverOpen && editingCatId && filters.some(f => f.categoryId === editingCatId);
                const popoverOnAdd = popoverOpen && !popoverOnPill;

                const popoverEl = (
                    <FilterPopover
                        isOpen={popoverOpen}
                        onClose={closePopover}
                        filter={editingFilter}
                        categoryId={editingCatId}
                        onSave={handleSave}
                        onDelete={handleDelete}
                    />
                );

                return (
                    <div style={{ display: "flex", flexWrap: "wrap", alignItems: "center", gap: 8 }}>
                        {filters.map((f) => (
                            <div key={f.categoryId} style={{ display: "flex", alignItems: "center", gap: 2, position: "relative" }}>
                                <div className="filter-pill" onClick={() => openEdit(f.categoryId)} style={{
                                    display: "flex", alignItems: "center", gap: 4,
                                    padding: "6px 10px 6px 12px", borderRadius: 8,
                                    border: "1.5px solid var(--color-bg-accent-blue-subtle)",
                                    background: "var(--color-bg-accent-blue-subtlest)",
                                    cursor: "pointer", fontSize: 13, fontWeight: 500,
                                    color: "var(--color-text-selected)",
                                    maxWidth: 280, overflow: "hidden",
                                }}>
                                    <span style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>
                                        {formatFilterLabel(f)}
                                    </span>
                                    <Icon name="chevronDown" size={14} color="var(--color-text-selected)" />
                                </div>
                                {popoverOnPill && editingCatId === f.categoryId && popoverEl}
                            </div>
                        ))}
                        <div style={{ position: "relative" }}>
                            <button onClick={openNew} style={{
                                display: "flex", alignItems: "center", gap: 4,
                                padding: "6px 12px", borderRadius: 8,
                                border: "1.5px solid var(--color-border-default)",
                                background: "var(--color-bg-primary)", cursor: "pointer",
                                fontSize: 13, fontWeight: 500, color: "var(--color-text-default)",
                            }}>
                                Add filter <Icon name="plus" size={14} />
                            </button>
                            {popoverOnAdd && popoverEl}
                        </div>
                        {filters.length === 0 && (
                            <span style={{ fontSize: 13, color: "var(--color-text-subtle)", marginLeft: 4 }}>
                                Apply filters to find exactly what you're looking for.
                            </span>
                        )}
                    </div>
                );
            }

            /* ─── ResultRow ───────────────────────────────────────── */
            function ResultRow({ item, checked, onToggle, onOpenInfo }) {
                const dot = TYPE_DOT[getItemType(item)] || TYPE_DOT.Business;
                return (
                    <div className="result-row" onClick={() => onToggle(item.id)} style={{
                        display: "flex", alignItems: "center", justifyContent: "space-between",
                        padding: "12px 32px", cursor: "pointer",
                        borderBottom: "1px solid var(--color-border-default)",
                    }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 20, minWidth: 0, flex: "0 1 auto" }}>
                            <Checkbox checked={checked} onChange={() => onToggle(item.id)} />
                            <span style={{
                                fontSize: 14, fontWeight: 600, whiteSpace: "nowrap",
                                overflow: "hidden", textOverflow: "ellipsis",
                            }}>{item.name}</span>
                        </div>
                        <div style={{ display: "flex", alignItems: "center", gap: 16, flexShrink: 0, marginLeft: 16 }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <span style={{
                                    fontSize: 12, fontWeight: 500,
                                    color: "var(--color-text-subtlest)", whiteSpace: "nowrap",
                                }}>{item.category}</span>
                                <div style={{
                                    width: 8, height: 8, borderRadius: "50%",
                                    background: dot, flexShrink: 0,
                                }} />
                            </div>
                            <div onClick={(e) => { e.stopPropagation(); onOpenInfo(item); }} style={{
                                cursor: "pointer", display: "flex", alignItems: "center",
                                color: "var(--color-icon-subtle)",
                                transition: "color .15s ease",
                            }}
                            onMouseEnter={e => e.currentTarget.style.color = "var(--color-icon-normal)"}
                            onMouseLeave={e => e.currentTarget.style.color = "var(--color-icon-subtle)"}>
                                <Icon name="arrow-right" size={20} />
                            </div>
                        </div>
                    </div>
                );
            }

            /* ─── ResultsList ─────────────────────────────────────── */
            function ResultsList({ items, selectedIds, onToggle, onSelectAll, onOpenInfo }) {
                const allChecked = items.length > 0 && items.every(i => selectedIds.has(i.id));

                return (
                    <div style={{ flex: 1, overflow: "auto" }}>
                        {/* Header */}
                        <div style={{
                            display: "flex", alignItems: "center", justifyContent: "space-between",
                            height: 48,
                            padding: "10px 32px",
                            borderBottom: "1px solid var(--color-border-default)",
                            borderTop: "1px solid var(--color-border-default)",
                            background: "var(--color-bg-secondary)",
                            position: "sticky", top: 0, zIndex: 2,
                        }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 20 }}>
                                <Checkbox checked={allChecked} onChange={() => onSelectAll(!allChecked)} />
                                <span style={{
                                    fontFamily: "'JetBrains Mono', monospace", fontSize: 12,
                                    fontWeight: 500, color: "var(--color-text-subtle)",
                                }}>{items.length} results</span>
                            </div>
                            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                                {[
                                    { label: "Business", color: TYPE_DOT.Business },
                                    { label: "POIs",     color: TYPE_DOT.POI },
                                    { label: "Area",     color: TYPE_DOT.Area },
                                ].map(legend => (
                                    <div key={legend.label} style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                        <div style={{
                                            width: 8, height: 8, borderRadius: "50%",
                                            background: legend.color, flexShrink: 0,
                                        }} />
                                        <span style={{
                                            fontSize: 12, fontWeight: 500,
                                            color: "var(--color-text-subtle)",
                                        }}>{legend.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {/* Rows */}
                        {items.map((item, i) => (
                            <ResultRow key={item.id} item={item}
                                checked={selectedIds.has(item.id)}
                                onToggle={onToggle}
                                onOpenInfo={onOpenInfo} />
                        ))}
                        {items.length === 0 && (
                            <div style={{
                                padding: "48px 16px", textAlign: "center",
                                color: "var(--color-text-subtlest)", fontSize: 14,
                            }}>
                                No results match your filters.
                            </div>
                        )}
                    </div>
                );
            }

            /* ─── TypeBadge ───────────────────────────────────────── */
            function TypeBadge({ type }) {
                const c = TYPE_COLORS[type] || TYPE_COLORS.Business;
                return (
                    <span style={{
                        display: "inline-block", padding: "2px 10px", borderRadius: 12,
                        fontSize: 12, fontWeight: 600,
                        border: `1.5px solid ${c.border}`,
                        color: c.text, background: c.bg,
                    }}>{type}</span>
                );
            }

            /* ─── Cart (floating overlay) ─────────────────────────── */
            function Cart({ selectedItems, onRemove, expanded, setExpanded }) {
                const scrollRef = useRef(null);
                const count = selectedItems.length;

                // collapse when all items removed
                useEffect(() => {
                    if (count === 0) setExpanded(false);
                }, [count]);

                // scroll to bottom when items added
                useEffect(() => {
                    const el = scrollRef.current;
                    if (el && expanded) {
                        el.scrollTop = el.scrollHeight;
                    }
                }, [count, expanded]);

                return (
                    <div className="cart-overlay" style={{
                        opacity: count > 0 ? 1 : 0,
                        pointerEvents: count > 0 ? "auto" : "none",
                    }}>
                        {/* Drawer — narrower than the bar, animates open/closed */}
                        <div className={`cart-drawer ${expanded && count > 0 ? "open" : "closed"}`}>
                            <div className="cart-card">
                                <div style={{
                                    fontSize: 14, fontWeight: 500,
                                    color: "var(--color-text-default)",
                                }}>
                                    Items ({count})
                                </div>
                                <div className="cart-inner">
                                    <div className="cart-card-scroll" ref={scrollRef}>
                                        {selectedItems.map((item, i) => {
                                            const c = TYPE_COLORS[item.type] || TYPE_COLORS.Business;
                                            return (
                                                <div key={item.id} className="cart-item"
                                                    style={{ animation: "cartItemIn .25s cubic-bezier(.4,0,.2,1) both",
                                                             animationDelay: `${Math.min(i * 0.03, 0.3)}s` }}>
                                                    <div style={{ flex: 1, minWidth: 0 }}>
                                                        <div style={{ fontSize: 14, fontWeight: 600 }}>{item.name}</div>
                                                    </div>
                                                    <div style={{ display: "flex", alignItems: "center", gap: 4, flexShrink: 0 }}>
                                                        <span style={{
                                                            fontSize: 12, fontWeight: 500,
                                                            color: "var(--color-text-subtlest)",
                                                        }}>{item.category}</span>
                                                        <div style={{
                                                            width: 32, display: "flex",
                                                            alignItems: "center", justifyContent: "center",
                                                        }}>
                                                            <div style={{
                                                                width: 12, height: 12, borderRadius: 2,
                                                                background: c.border,
                                                                border: `1px solid ${c.text}`,
                                                            }} />
                                                        </div>
                                                        <div onClick={() => onRemove(item.id)} style={{
                                                            cursor: "pointer", display: "flex",
                                                            alignItems: "center", justifyContent: "center",
                                                            color: "var(--color-text-default)",
                                                            transition: "opacity .15s ease",
                                                        }}
                                                        onMouseEnter={e => e.currentTarget.style.opacity = ".5"}
                                                        onMouseLeave={e => e.currentTarget.style.opacity = "1"}>
                                                            <Icon name="circle-x" size={16} />
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Blue bottom bar — full width */}
                        <div className={`cart-bar ${count === 0 ? "hidden" : ""}`} style={{
                            display: "flex", alignItems: "center", justifyContent: "space-between",
                            padding: 16,
                        }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <div style={{
                                    display: "flex", alignItems: "center", justifyContent: "center",
                                    background: "var(--color-bg-accent-blue-subtler)",
                                    color: "var(--color-text-selected)",
                                    fontFamily: "var(--font-mono)", fontWeight: 500,
                                    fontSize: 14, borderRadius: 8, width: 32, height: 32,
                                }}>{count}</div>
                                <span style={{ fontSize: 14, fontWeight: 500, color: "#FFFDF6" }}>
                                    items selected
                                </span>
                            </div>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <button onClick={() => setExpanded(!expanded)} style={{
                                    padding: "0 16px", borderRadius: 8, height: 40,
                                    border: "1px solid var(--color-border-accent-blue-subtle, rgba(255,255,255,.35))",
                                    background: "transparent", cursor: "pointer",
                                    fontSize: 14, fontWeight: 500, color: "#FFFDF6",
                                }}>
                                    {expanded ? "Collapse" : "Review"}
                                </button>
                                <button onClick={() => alert("Items added to Day 1!")} style={{
                                    padding: "0 16px", borderRadius: 8, height: 40,
                                    border: "1px solid var(--color-bg-selected-bold)",
                                    background: "var(--color-bg-accent-blue-default, #e1eceb)", cursor: "pointer",
                                    fontSize: 14, fontWeight: 500,
                                    color: "var(--color-text-selected, #205ea6)",
                                }}>
                                    Add items to Day 1
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            /* ─── StopInfoPanel ─────────────────────────────────── */
            function StopInfoPanel({ item, isOpen, onClose }) {
                if (!item) return null;
                const itemType = getItemType(item);
                const dot = TYPE_DOT[itemType] || TYPE_DOT.Business;
                return (
                    <div style={{
                        position: "absolute", inset: 0, zIndex: 50,
                        background: "var(--color-bg-primary)",
                        overflowY: isOpen ? "auto" : "hidden",
                        transform: isOpen ? "scale(1)" : "scale(0.96)",
                        opacity: isOpen ? 1 : 0,
                        filter: isOpen ? "blur(0)" : "blur(6px)",
                        transformOrigin: "center bottom",
                        transition: "transform 300ms cubic-bezier(.2,0,0,1), opacity 300ms cubic-bezier(.2,0,0,1), filter 300ms cubic-bezier(.2,0,0,1)",
                        willChange: "transform, opacity, filter",
                        pointerEvents: isOpen ? "auto" : "none",
                    }}>
                        <div style={{ padding: "40px 32px 0" }}>
                            <div onClick={onClose} style={{
                                display: "inline-flex", alignItems: "center", gap: 4,
                                height: 32, padding: "0 12px", borderRadius: 8,
                                background: "var(--color-overlay-blur-bg)",
                                backdropFilter: "blur(12px)", WebkitBackdropFilter: "blur(12px)",
                                boxShadow: "var(--shadow-overlay)",
                                cursor: "pointer", fontWeight: 500, fontSize: 14,
                                color: "var(--color-text-default)", lineHeight: "22px",
                            }}>
                                <Icon name="arrow-left" size={16} />
                                Back
                            </div>
                        </div>
                        <div style={{ padding: "32px 32px 48px", display: "flex", flexDirection: "column", gap: 24 }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                                <div style={{
                                    width: 10, height: 10, borderRadius: "50%",
                                    background: dot, flexShrink: 0,
                                }} />
                                <span style={{ fontSize: 13, fontWeight: 500, color: "var(--color-text-subtle)" }}>
                                    {itemType}
                                </span>
                            </div>
                            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
                                <h2 style={{
                                    margin: 0, fontFamily: "Outfit", fontWeight: 600,
                                    fontSize: 24, lineHeight: "32px",
                                    color: "var(--color-text-default)",
                                }}>{item.name}</h2>
                                <p style={{
                                    margin: 0, fontSize: 14, fontWeight: 500,
                                    color: "var(--color-text-subtle)", lineHeight: "22px",
                                }}>{item.category}</p>
                            </div>
                            <div style={{
                                display: "flex", flexDirection: "column", gap: 12,
                                padding: 20, borderRadius: 12,
                                background: "var(--color-bg-secondary)",
                                border: "1px solid var(--color-border-default)",
                            }}>
                                <div style={{ display: "flex", justifyContent: "space-between" }}>
                                    <span style={{ fontSize: 13, color: "var(--color-text-subtle)" }}>Region</span>
                                    <span style={{ fontSize: 13, fontWeight: 500 }}>{item.region}</span>
                                </div>
                                {item.tags && item.tags.length > 0 && (
                                    <div style={{ display: "flex", justifyContent: "space-between" }}>
                                        <span style={{ fontSize: 13, color: "var(--color-text-subtle)" }}>Tags</span>
                                        <span style={{ fontSize: 13, fontWeight: 500 }}>{item.tags.join(", ")}</span>
                                    </div>
                                )}
                                <div style={{ display: "flex", justifyContent: "space-between" }}>
                                    <span style={{ fontSize: 13, color: "var(--color-text-subtle)" }}>Coordinates</span>
                                    <span style={{
                                        fontSize: 12, fontWeight: 500,
                                        fontFamily: "'JetBrains Mono', monospace",
                                        color: "var(--color-text-subtle)",
                                    }}>{item.lat.toFixed(4)}, {item.lng.toFixed(4)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            /* ─── Mapbox token ────────────────────────────────────── */
            const MAPBOX_TOKEN = "pk.eyJ1Ijoib2NyZXVyZXIiLCJhIjoiY2thNWcydHd0MGVieTNncXlhbmx6ajJ2eSJ9.OEcyIWzbV9-kwdpRVqSmLg";

            /* ─── MapPanel ───────────────────────────────────────── */
            function MapPanel({ items, selectedIds, isDark, activeRegions, onToggle }) {
                const containerRef = useRef(null);
                const mapRef = useRef(null);
                const readyRef = useRef(false);
                const dataRef = useRef({ items, selectedIds, activeRegions, onToggle, isDark });
                dataRef.current = { items, selectedIds, activeRegions, onToggle, isDark };

                // initialise map once
                useEffect(() => {
                    if (!containerRef.current || mapRef.current) return;
                    mapboxgl.accessToken = MAPBOX_TOKEN;
                    const map = new mapboxgl.Map({
                        container: containerRef.current,
                        style: "mapbox://styles/mapbox/standard",
                        center: [-73.575, 45.510],
                        zoom: 1,
                        pitch: 0,
                        bearing: -40,
                        attributionControl: true,
                        config: {
                            basemap: {
                                theme: "monochrome",
                                lightPreset: "dawn",
                                showPointOfInterestLabels: false,
                                showPlaceLabels: false,
                                showTransitLabels: false,
                            },
                        },
                    });
                    map.addControl(new mapboxgl.NavigationControl(), "top-left");

                    map.on("load", () => {
                        /* empty source — we'll update it via the other effect */
                        map.addSource("explorer-points", {
                            type: "geojson",
                            data: { type: "FeatureCollection", features: [] },
                        });

                        /* circle layer for all results */
                        map.addLayer({
                            id: "explorer-circles",
                            type: "circle",
                            source: "explorer-points",
                            paint: {
                                "circle-radius": ["case", ["get", "selected"], 7, 5],
                                "circle-color": ["get", "color"],
                                "circle-stroke-width": ["case", ["get", "selected"], 2.5, 1.5],
                                "circle-stroke-color": ["get", "stroke"],
                                "circle-opacity": 0.9,
                                "circle-emissive-strength": 1,
                                "circle-stroke-emissive-strength": 1,
                            },
                        });

                        /* name labels — only visible at high zoom */
                        map.addLayer({
                            id: "explorer-labels",
                            type: "symbol",
                            source: "explorer-points",
                            minzoom: 13.5,
                            layout: {
                                "text-field": ["get", "name"],
                                "text-font": ["DIN Pro Medium", "Arial Unicode MS Regular"],
                                "text-size": 12,
                                "text-anchor": "bottom",
                                "text-offset": [0, -0.8],
                                "text-max-width": 10,
                            },
                            paint: {
                                "text-color": ["get", "color"],
                                "text-halo-color": "#ffffff",
                                "text-halo-width": 1.5,
                                "text-emissive-strength": 1,
                            },
                        });

                        /* click marker or label to toggle selection */
                        const handleMarkerClick = (e) => {
                            const f = e.features[0];
                            const id = f.properties.id;
                            if (id != null && dataRef.current.onToggle) {
                                dataRef.current.onToggle(id);
                            }
                        };
                        map.on("click", "explorer-circles", handleMarkerClick);
                        map.on("click", "explorer-labels", handleMarkerClick);
                        map.on("mouseenter", "explorer-circles", () => { map.getCanvas().style.cursor = "pointer"; });
                        map.on("mouseleave", "explorer-circles", () => { map.getCanvas().style.cursor = ""; });
                        map.on("mouseenter", "explorer-labels", () => { map.getCanvas().style.cursor = "pointer"; });
                        map.on("mouseleave", "explorer-labels", () => { map.getCanvas().style.cursor = ""; });

                        /* region boundary polygon layers */
                        map.addSource("region-boundary", {
                            type: "geojson",
                            data: { type: "FeatureCollection", features: [] },
                        });
                        map.addLayer({
                            id: "region-boundary-fill",
                            type: "fill",
                            source: "region-boundary",
                            paint: { "fill-color": "#205EA6", "fill-opacity": 0.08, "fill-emissive-strength": 1 },
                        }, "explorer-circles");
                        map.addLayer({
                            id: "region-boundary-line",
                            type: "line",
                            source: "region-boundary",
                            paint: { "line-color": "#205EA6", "line-width": 2.5, "line-opacity": 0.45, "line-emissive-strength": 1 },
                        }, "explorer-circles");

                        /* populate initial markers from current data */
                        const { items: itms, selectedIds: sel, activeRegions: ar, isDark: dk } = dataRef.current;
                        const mc = dk ? TYPE_DOT : TYPE_MAP;
                        const feats = itms.map(item => ({
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [item.lng, item.lat] },
                            properties: {
                                id: item.id, name: item.name, category: item.category,
                                selected: sel.has(item.id),
                                color: sel.has(item.id) ? "#205EA6" : (item.category === "Provincial Park" ? mc.Area : (item.type === "POI" ? mc.POI : mc.Business)),
                                stroke: sel.has(item.id) ? "#205EA6" : (item.category === "Provincial Park" ? mc.Area : (item.type === "POI" ? mc.POI : mc.Business)),
                            },
                        }));
                        map.getSource("explorer-points").setData({ type: "FeatureCollection", features: feats });

                        /* populate initial region polygons if any are active */
                        if (ar && ar.length > 0) {
                            const polyFeats = ar
                                .filter(r => REGION_BOUNDARIES[r])
                                .map(r => ({
                                    type: "Feature",
                                    geometry: { type: "Polygon", coordinates: [REGION_BOUNDARIES[r]] },
                                    properties: { region: r },
                                }));
                            map.getSource("region-boundary").setData({ type: "FeatureCollection", features: polyFeats });
                            const bounds = new mapboxgl.LngLatBounds();
                            polyFeats.forEach(f => {
                                f.geometry.coordinates[0].forEach(c => bounds.extend(c));
                            });
                            itms.forEach(item => {
                                if (ar.includes(item.region)) bounds.extend([item.lng, item.lat]);
                            });
                            map.fitBounds(bounds, {
                                padding: { top: 80, bottom: 80, left: 60, right: 60 },
                                duration: 1500, maxZoom: 15.5,
                            });
                        }

                        /* opening fly-in: swoop down to fit all markers */
                        const introBounds = new mapboxgl.LngLatBounds();
                        feats.forEach(f => introBounds.extend(f.geometry.coordinates));
                        setTimeout(() => {
                            map.fitBounds(introBounds, {
                                padding: { top: 60, bottom: 60, left: 60, right: 60 },
                                pitch: 0,
                                bearing: 0,
                                duration: 3000,
                                maxZoom: 15,
                                easing: t => t < 0.5
                                    ? 4 * t * t * t
                                    : 1 - Math.pow(-2 * t + 2, 3) / 2,
                            });
                        }, 200);

                        readyRef.current = true;
                    });

                    mapRef.current = map;
                    return () => { map.remove(); mapRef.current = null; };
                }, []);

                // helper: build GeoJSON from current data
                const updateMarkers = useCallback(() => {
                    const map = mapRef.current;
                    if (!map || !readyRef.current) return;
                    const src = map.getSource("explorer-points");
                    if (!src) return;
                    const { items: itms, selectedIds: sel, isDark: dk } = dataRef.current;
                    const mc = dk ? TYPE_DOT : TYPE_MAP;
                    const features = itms.map(item => {
                        const isSel = sel.has(item.id);
                        return {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [item.lng, item.lat] },
                            properties: {
                                id: item.id,
                                name: item.name,
                                category: item.category,
                                selected: isSel,
                                color: isSel ? "#205EA6" : (item.category === "Provincial Park" ? mc.Area : (item.type === "POI" ? mc.POI : mc.Business)),
                                stroke: isSel ? "#205EA6" : (item.category === "Provincial Park" ? mc.Area : (item.type === "POI" ? mc.POI : mc.Business)),
                            },
                        };
                    });
                    src.setData({ type: "FeatureCollection", features });
                }, []);

                // update source whenever items or selection change
                useEffect(() => { updateMarkers(); }, [items, selectedIds]);

                // switch light preset on dark mode toggle + re-apply markers + polygon opacity
                useEffect(() => {
                    const map = mapRef.current;
                    if (!map || !readyRef.current) return;
                    map.setConfigProperty("basemap", "lightPreset", isDark ? "night" : "dawn");
                    // boost polygon visibility in dark mode
                    if (map.getLayer("region-boundary-fill")) {
                        map.setPaintProperty("region-boundary-fill", "fill-color", isDark ? "#4385BE" : "#205EA6");
                        map.setPaintProperty("region-boundary-fill", "fill-opacity", isDark ? 0.25 : 0.08);
                    }
                    if (map.getLayer("region-boundary-line")) {
                        map.setPaintProperty("region-boundary-line", "line-color", isDark ? "#4385BE" : "#205EA6");
                        map.setPaintProperty("region-boundary-line", "line-opacity", isDark ? 0.7 : 0.45);
                    }
                    // dark halo on labels in dark mode
                    if (map.getLayer("explorer-labels")) {
                        map.setPaintProperty("explorer-labels", "text-halo-color", isDark ? "#1C1B1A" : "#ffffff");
                    }
                    setTimeout(() => updateMarkers(), 150);
                }, [isDark]);

                // draw region boundary polygons + fit bounds when regions change
                useEffect(() => {
                    const map = mapRef.current;
                    if (!map || !readyRef.current) return;
                    const src = map.getSource("region-boundary");
                    if (!src) return;

                    if (!activeRegions || activeRegions.length === 0) {
                        // clear polygons, fit to all current markers
                        src.setData({ type: "FeatureCollection", features: [] });
                        const { items: itms } = dataRef.current;
                        const resetBounds = new mapboxgl.LngLatBounds();
                        itms.forEach(item => resetBounds.extend([item.lng, item.lat]));
                        if (!resetBounds.isEmpty()) {
                            map.fitBounds(resetBounds, {
                                padding: { top: 60, bottom: 60, left: 60, right: 60 },
                                pitch: 0, bearing: 0, duration: 1200, maxZoom: 15,
                            });
                        }
                        return;
                    }

                    // build polygon features for each active region
                    const features = activeRegions
                        .filter(r => REGION_BOUNDARIES[r])
                        .map(r => ({
                            type: "Feature",
                            geometry: { type: "Polygon", coordinates: [REGION_BOUNDARIES[r]] },
                            properties: { region: r },
                        }));
                    src.setData({ type: "FeatureCollection", features });

                    // fit bounds to selected regions
                    const bounds = new mapboxgl.LngLatBounds();
                    features.forEach(f => {
                        f.geometry.coordinates[0].forEach(c => bounds.extend(c));
                    });
                    // also include the markers within these regions
                    items.forEach(item => {
                        if (activeRegions.includes(item.region)) {
                            bounds.extend([item.lng, item.lat]);
                        }
                    });
                    map.fitBounds(bounds, {
                        padding: { top: 80, bottom: 80, left: 60, right: 60 },
                        duration: 1500,
                        maxZoom: 15.5,
                    });
                }, [activeRegions]);

                return (
                    <div ref={containerRef} style={{ flex: 1, minWidth: 0 }} />
                );
            }

            /* ─── App ─────────────────────────────────────────────── */
            function App() {
                const [isDark, setIsDark] = useState(false);
                const [searchQuery, setSearchQuery] = useState("");
                const [filters, setFilters] = useState([]);
                const [selectedIds, setSelectedIds] = useState(new Set());
                const [cartExpanded, setCartExpanded] = useState(false);
                const [openInfoItem, setOpenInfoItem] = useState(null);

                const toggleDark = useCallback(() => {
                    setIsDark(prev => {
                        const next = !prev;
                        document.documentElement.classList.toggle("dark", next);
                        return next;
                    });
                }, []);

                /* filtering pipeline */
                const filteredItems = useMemo(() => {
                    let result = [...ITEMS];

                    for (const f of filters) {
                        const cat = FILTER_CATEGORIES.find(c => c.id === f.categoryId);
                        if (!cat) continue;

                        if (f.rule === "is empty") { result = result.filter(item => !getFieldValue(item, cat.field)); continue; }
                        if (f.rule === "is not empty") { result = result.filter(item => !!getFieldValue(item, cat.field)); continue; }

                        const selectedValues = flattenSelections(f.selected, cat);
                        if (selectedValues.length === 0) continue;

                        if (f.rule === "is") result = result.filter(item => matchesFilter(item, cat.field, selectedValues));
                        if (f.rule === "is not") result = result.filter(item => !matchesFilter(item, cat.field, selectedValues));
                    }

                    // search
                    if (searchQuery.trim()) {
                        const q = searchQuery.toLowerCase();
                        result = result.filter(i =>
                            i.name.toLowerCase().includes(q) ||
                            i.category.toLowerCase().includes(q)
                        );
                    }

                    result.sort((a, b) => a.name.localeCompare(b.name));
                    return result;
                }, [filters, searchQuery]);

                const toggleItem = useCallback((id) => {
                    setSelectedIds(prev => {
                        const next = new Set(prev);
                        if (next.has(id)) next.delete(id); else next.add(id);
                        return next;
                    });
                }, []);

                const selectAll = useCallback((selectAll) => {
                    if (selectAll) {
                        setSelectedIds(prev => {
                            const next = new Set(prev);
                            filteredItems.forEach(i => next.add(i.id));
                            return next;
                        });
                    } else {
                        setSelectedIds(prev => {
                            const next = new Set(prev);
                            filteredItems.forEach(i => next.delete(i.id));
                            return next;
                        });
                    }
                }, [filteredItems]);

                const selectedItems = ITEMS.filter(i => selectedIds.has(i.id));

                const activeRegions = useMemo(() => {
                    const rf = filters.find(f => f.categoryId === "region");
                    if (!rf || rf.rule === "is empty" || rf.rule === "is not empty") return [];
                    const regionCat = FILTER_CATEGORIES.find(c => c.id === "region");
                    const vals = flattenSelections(rf.selected, regionCat);
                    if (rf.rule === "is") return vals;
                    /* "is not" — return all regions EXCEPT selected */
                    const allRegions = [...new Set(ITEMS.map(i => i.region))];
                    return allRegions.filter(r => !vals.includes(r));
                }, [filters]);

                /* live-apply: create or update filter by categoryId */
                const updateFilter = useCallback((categoryId, rule, selected) => {
                    setFilters(prev => {
                        const idx = prev.findIndex(f => f.categoryId === categoryId);
                        /* if nothing selected and rule doesn't stand alone, remove */
                        const isEmpty = Object.keys(selected).length === 0
                            && rule !== "is empty" && rule !== "is not empty";
                        if (isEmpty) {
                            return idx >= 0 ? prev.filter((_, i) => i !== idx) : prev;
                        }
                        const entry = { categoryId, rule, selected };
                        if (idx >= 0) return prev.map((f, i) => i === idx ? entry : f);
                        return [...prev, entry];
                    });
                }, []);
                const removeFilter = useCallback((categoryId) => {
                    setFilters(prev => prev.filter(f => f.categoryId !== categoryId));
                }, []);

                return (
                    <div style={{
                        display: "flex", height: "100%", width: "100%",
                        fontFamily: "var(--body-font), sans-serif",
                        position: "relative",
                    }}>
                        {/* ─── Left panel (map) ─────────────────── */}
                        <MapPanel
                            items={filteredItems}
                            selectedIds={selectedIds}
                            isDark={isDark}
                            activeRegions={activeRegions}
                            onToggle={toggleItem}
                        />

                        {/* ─── Right panel (explorer) ───────────────── */}
                        <div style={{
                            width: 520, flexShrink: 0, display: "flex", flexDirection: "column",
                            position: "relative", borderLeft: "1px solid var(--color-border-default)",
                        }}>
                            {/* Header */}
                            <div style={{ padding: "40px 32px 24px" }}>
                                <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                                    <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between" }}>
                                        <h1 style={{
                                            fontFamily: "Outfit", fontSize: 18, fontWeight: 600,
                                            lineHeight: "24px", margin: 0,
                                        }}>Explorer</h1>
                                        <button onClick={toggleDark} style={{
                                            background: "none", border: "none", cursor: "pointer",
                                            padding: 6, borderRadius: 8, color: "var(--color-icon-subtle)",
                                            display: "flex", alignItems: "center", justifyContent: "center",
                                        }}>
                                            <Icon name={isDark ? "sun" : "moon"} size={18} />
                                        </button>
                                    </div>
                                    <p style={{
                                        fontSize: 16, color: "var(--color-text-subtle)",
                                        lineHeight: "24px", margin: 0,
                                    }}>
                                        Search within your account or across Whereabouts' extensive database of
                                        tourism businesses, organizations, and points of interest.
                                    </p>
                                </div>
                                <div style={{ marginTop: 24, display: "flex", flexDirection: "column", gap: 16 }}>
                                    <SearchBar value={searchQuery} onChange={setSearchQuery} />
                                    <FilterBar
                                        filters={filters}
                                        onUpdateFilter={updateFilter}
                                        onRemoveFilter={removeFilter}
                                    />
                                </div>
                            </div>

                            {/* Results */}
                            <ResultsList
                                items={filteredItems}
                                selectedIds={selectedIds}
                                onToggle={toggleItem}
                                onSelectAll={selectAll}
                                onOpenInfo={setOpenInfoItem}
                            />

                            {/* Dim scrim behind info panel */}
                            <div onClick={() => setOpenInfoItem(null)} style={{
                                position: "absolute", inset: 0, zIndex: 49,
                                background: "var(--color-overlay-scrim)",
                                opacity: openInfoItem ? 1 : 0,
                                pointerEvents: openInfoItem ? "auto" : "none",
                                transition: "opacity 200ms ease",
                            }} />

                            {/* Stop info panel */}
                            <StopInfoPanel
                                item={openInfoItem}
                                isOpen={!!openInfoItem}
                                onClose={() => setOpenInfoItem(null)}
                            />
                        </div>

                        {/* ─── Cart scrim + overlay ─────────────────── */}
                        <div
                            className={`cart-scrim ${cartExpanded && selectedItems.length > 0 ? "active" : ""}`}
                            onClick={() => setCartExpanded(false)}
                        />
                        <Cart
                            selectedItems={selectedItems}
                            onRemove={(id) => toggleItem(id)}
                            expanded={cartExpanded}
                            setExpanded={setCartExpanded}
                        />
                    </div>
                );
            }

            /* ─── Mount ────────────────────────────────────────────── */
            ReactDOM.createRoot(document.getElementById("root")).render(<App />);
        </script>
    </body>
</html>
