<!doctype html>
<html lang="en" style="--body-font: &quot;Outfit&quot;">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Explorer</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&family=Platypi:wght@400;500;600&family=Lato:wght@400;700;900&family=JetBrains+Mono:wght@400&display=swap"
            rel="stylesheet"
        />
        <style>
            /* ─── Design tokens (light mode) ─────────────────────── */
            :root {
                /* Background — base */
                --color-bg-primary: #FFFDF6;
                --color-bg-secondary: #F7F6ED;
                --color-bg-inverted: #100F0F;
                --color-bg-inverted-hovered: #282726;
                --color-bg-neutral-subtler: #E6E4D9;
                --color-bg-neutral-bold: #6F6E69;
                --color-bg-disabled: #E6E4D9;
                --color-bg-input: #F7F6ED;

                /* Background — selected */
                --color-bg-selected-bold: #205EA6;

                /* Background — accent */
                --color-bg-accent-orange-subtlest: #FFE7CE;
                --color-bg-accent-orange-subtler: #FED3AF;
                --color-bg-accent-orange-subtle: #F9AE77;
                --color-bg-accent-orange-bolder: #BC5215;
                --color-bg-accent-yellow-subtlest: #FAEEC6;
                --color-bg-accent-yellow-subtler: #F6E2A0;
                --color-bg-accent-yellow-subtle: #ECCB60;
                --color-bg-accent-yellow-bolder: #AD8301;
                --color-bg-accent-green-subtlest: #EDEECF;
                --color-bg-accent-green-subtler: #DDE2B2;
                --color-bg-accent-green-subtle: #BEC97E;
                --color-bg-accent-green-bolder: #66800B;
                --color-bg-accent-blue-subtlest: #E1ECEB;
                --color-bg-accent-blue-subtler: #C6DDE8;
                --color-bg-accent-blue-subtle: #92BFDB;
                --color-bg-accent-blue-bolder: #205EA6;
                --color-bg-accent-purple-subtlest: #F0EAEC;
                --color-bg-accent-purple-subtler: #E2D9E9;
                --color-bg-accent-purple-subtle: #C4B9E0;
                --color-bg-accent-purple-bolder: #5E409D;

                /* Background — success */
                --color-bg-success-bold: #66800B;
                --color-bg-success-bold-hovered: #536907;

                /* Text */
                --color-text-default: #100F0F;
                --color-text-subtle: #6F6E69;
                --color-text-subtlest: #B7B5AC;
                --color-text-disabled: #B7B5AC;
                --color-text-inverse: #FFFDF6;
                --color-text-selected: #205EA6;
                --color-text-information: #205EA6;
                --color-text-accent-green: #66800B;
                --color-text-accent-green-bolder: #536907;
                --color-text-accent-purple: #5E409D;
                --color-text-accent-yellow: #AD8301;

                /* Icon */
                --color-icon-normal: #100F0F;
                --color-icon-subtle: #6F6E69;
                --color-icon-subtlest: #B7B5AC;
                --color-icon-inverse: #FFFDF6;

                /* Border */
                --color-border-default: #DAD8CE;
                --color-border-bold: #B7B5AC;
                --color-border-boldest: #100F0F;
                --color-border-inverse: #FFFDF6;
                --color-border-input: #DAD8CE;
                --color-border-accent-green: #66800B;
                --color-border-accent-purple: #5E409D;
                --color-border-accent-yellow: #AD8301;
                --color-border-selected: #205EA6;

                /* Link */
                --color-link-default: #24837B;

                /* Elevation / surfaces */
                --color-elevation-surface: #FFFFFF;

                /* Opacity overlays */
                --color-overlay-scrim: rgba(255, 253, 246, 0.7);
                --color-overlay-blur-bg: rgba(255, 253, 246, 0.55);

                /* Shadows */
                --shadow-overlay: 0 2px 12px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.06);
                --shadow-card: 0 2px 12px rgba(0,0,0,.12), 0 0 0 1px rgba(0,0,0,.06);
                --shadow-badge: 0 0 4px 0 rgba(0, 0, 0, 0.40);
                --shadow-toggle-knob: 0 1px 3px rgba(0,0,0,.15);
            }

            /* ─── Design tokens (dark mode) ──────────────────────── */
            html.dark {
                --color-bg-primary: #100F0F;
                --color-bg-secondary: #1C1B1A;
                --color-bg-inverted: #FFFDF6;
                --color-bg-inverted-hovered: #F7F6ED;
                --color-bg-neutral-subtler: #282726;
                --color-bg-neutral-bold: #B7B5AC;
                --color-bg-disabled: #343331;
                --color-bg-input: #1C1B1A;

                --color-bg-selected-bold: #4385BE;

                --color-bg-accent-orange-subtlest: #27180E;
                --color-bg-accent-orange-subtler: #40200D;
                --color-bg-accent-orange-subtle: #71320D;
                --color-bg-accent-orange-bolder: #EC8B49;
                --color-bg-accent-yellow-subtlest: #241E08;
                --color-bg-accent-yellow-subtler: #3A2D04;
                --color-bg-accent-yellow-subtle: #664D01;
                --color-bg-accent-yellow-bolder: #DFB431;
                --color-bg-accent-green-subtlest: #1A1E0C;
                --color-bg-accent-green-subtler: #252D09;
                --color-bg-accent-green-subtle: #3D4C07;
                --color-bg-accent-green-bolder: #A0AF54;
                --color-bg-accent-blue-subtlest: #101A24;
                --color-bg-accent-blue-subtler: #12253B;
                --color-bg-accent-blue-subtle: #163B66;
                --color-bg-accent-blue-bolder: #66A0C8;
                --color-bg-accent-purple-subtlest: #1A1623;
                --color-bg-accent-purple-subtler: #261C39;
                --color-bg-accent-purple-subtle: #3C2A62;
                --color-bg-accent-purple-bolder: #A699D0;

                --color-bg-success-bold: #A0AF54;
                --color-bg-success-bold-hovered: #BEC97E;

                --color-text-default: #CECDC3;
                --color-text-subtle: #878580;
                --color-text-subtlest: #575653;
                --color-text-disabled: #575653;
                --color-text-inverse: #100F0F;
                --color-text-selected: #66A0C8;
                --color-text-information: #66A0C8;
                --color-text-accent-green: #A0AF54;
                --color-text-accent-green-bolder: #BEC97E;
                --color-text-accent-purple: #A699D0;
                --color-text-accent-yellow: #DFB431;

                --color-icon-normal: #CECDC3;
                --color-icon-subtle: #878580;
                --color-icon-subtlest: #575653;
                --color-icon-inverse: #100F0F;

                --color-border-default: #343331;
                --color-border-bold: #6F6E69;
                --color-border-boldest: #CECDC3;
                --color-border-inverse: #100F0F;
                --color-border-input: #343331;
                --color-border-accent-green: #879A39;
                --color-border-accent-purple: #A699D0;
                --color-border-accent-yellow: #DFB431;
                --color-border-selected: #4385BE;

                --color-link-default: #3AA99F;

                --color-elevation-surface: #1C1B1A;

                --color-overlay-scrim: rgba(16, 15, 15, 0.7);
                --color-overlay-blur-bg: rgba(16, 15, 15, 0.55);

                --shadow-overlay: 0 2px 12px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.06);
                --shadow-card: 0 2px 12px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.06);
                --shadow-badge: 0 0 4px 0 rgba(0, 0, 0, 0.60);
                --shadow-toggle-knob: 0 1px 3px rgba(0,0,0,.3);
            }

            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            html,
            body,
            #root {
                height: 100%;
                width: 100%;
                overflow: hidden;
            }
            body {
                background: var(--color-bg-primary);
                color: var(--color-text-default);
                font-family: var(--body-font), sans-serif;
                -webkit-font-smoothing: antialiased;
                transition: background .3s ease, color .3s ease;
            }
            ::-webkit-scrollbar {
                width: 0;
                height: 0;
                background: transparent;
            }
            input, select, textarea, button {
                font-family: inherit;
                font-size: inherit;
                color: inherit;
            }

            /* ─── Explorer-specific styles ───────────────────────── */
            .result-row {
                transition: background .15s ease;
            }
            .result-row:hover {
                background: var(--color-bg-neutral-subtler);
            }
            .filter-pill {
                transition: background .15s ease, border-color .15s ease;
            }
            .filter-pill:hover {
                border-color: var(--color-border-bold);
            }
            .selection-tray {
                transition: transform .3s cubic-bezier(.4, 0, .2, 1), opacity .3s ease;
            }
            .selection-tray.hidden {
                transform: translateY(100%);
                opacity: 0;
                pointer-events: none;
            }
            .selection-card {
                transition: background .15s ease;
            }
            .selection-card:hover {
                background: var(--color-bg-neutral-subtler);
            }
            .segment-tab {
                transition: background .15s ease, color .15s ease, border-color .15s ease;
                cursor: pointer;
                user-select: none;
            }
            .segment-tab:hover:not(.active) {
                background: var(--color-bg-neutral-subtler);
            }
            .filter-dropdown {
                animation: dropdownIn .15s ease;
            }
            @keyframes dropdownIn {
                from { opacity: 0; transform: translateY(-4px); }
                to   { opacity: 1; transform: translateY(0); }
            }
            .review-panel {
                transition: max-height .3s cubic-bezier(.4, 0, .2, 1), opacity .2s ease;
                overflow: hidden;
            }
            .review-panel.collapsed {
                max-height: 0;
                opacity: 0;
            }
            .review-panel.expanded {
                max-height: 400px;
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
        <script>
            window.onerror = function (msg, url, line, col, err) {
                var d = document.createElement("div");
                d.style.cssText =
                    "position:fixed;top:0;left:0;right:0;z-index:99999;background:#fee;color:#900;padding:16px;font:14px monospace;white-space:pre-wrap;max-height:40vh;overflow:auto";
                d.textContent =
                    "ERROR: " + msg + "\nLine: " + line + ", Col: " + col +
                    (err && err.stack ? "\n\nStack:\n" + err.stack : "");
                document.body.prepend(d);
            };
        </script>
        <script>
            (function () {
                document.documentElement.classList.remove("dark");
            })();
        </script>
        <script type="text/babel" data-type="module">
            const { useState, useEffect, useRef, useCallback, useMemo } = React;

            /* ─── Dummy data ──────────────────────────────────────── */
            const ITEMS = [
                { id: 1,  name: "Atmosphere Bikes",            category: "Accommodation",       type: "Business", region: "Montreal",  tags: ["Southside"] },
                { id: 2,  name: "Cardinal Café",               category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Southside"] },
                { id: 3,  name: "Montreal Museum of Fine Arts", category: "Cultural Attraction", type: "POI",      region: "Montreal",  tags: [] },
                { id: 4,  name: "Dunya",                       category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Downtown"] },
                { id: 5,  name: "Java Café",                   category: "Accommodation",       type: "Business", region: "Montreal",  tags: [] },
                { id: 6,  name: "Billy's Diner",               category: "Food & Beverage",     type: "Business", region: "Ottawa",    tags: ["Byward"] },
                { id: 7,  name: "Blue Ridge Cottages",          category: "Accommodation",       type: "POI",      region: "Ottawa",    tags: [] },
                { id: 8,  name: "Sweet's Candy Shop",          category: "Retail",              type: "Business", region: "Ottawa",    tags: ["Byward"] },
                { id: 9,  name: "The Lonesome Rose",           category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Southside"] },
                { id: 10, name: "Parsons Provincial Park",     category: "Provincial Park",     type: "POI",      region: "Ottawa",    tags: [] },
                { id: 11, name: "Fin & Feather",               category: "Retail",              type: "POI",      region: "Montreal",  tags: [] },
                { id: 12, name: "Le Plateau Bistro",           category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Downtown"] },
                { id: 13, name: "Rideau Canal Locks",          category: "Cultural Attraction", type: "POI",      region: "Ottawa",    tags: [] },
                { id: 14, name: "Maple Grove Inn",             category: "Accommodation",       type: "Business", region: "Ottawa",    tags: [] },
                { id: 15, name: "Chez Laurent",                category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Downtown", "Southside"] },
                { id: 16, name: "Parliament Hill",             category: "Cultural Attraction", type: "POI",      region: "Ottawa",    tags: [] },
                { id: 17, name: "Gatineau Hot Springs",        category: "Accommodation",       type: "Business", region: "Ottawa",    tags: [] },
                { id: 18, name: "The Night Owl Pub",           category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: ["Southside"] },
                { id: 19, name: "Byward Market Flowers",       category: "Retail",              type: "Business", region: "Ottawa",    tags: ["Byward"] },
                { id: 20, name: "Mont Royal Lookout",          category: "Provincial Park",     type: "POI",      region: "Montreal",  tags: [] },
                { id: 21, name: "La Cabane à Sucre",           category: "Food & Beverage",     type: "Business", region: "Montreal",  tags: [] },
                { id: 22, name: "Champlain Bridge Viewpoint",  category: "Cultural Attraction", type: "POI",      region: "Montreal",  tags: [] },
            ];

            const FILTER_OPTIONS = {
                "Region":        [...new Set(ITEMS.map(i => i.region))],
                "Category":      [...new Set(ITEMS.map(i => i.category))],
                "Custom Tag":    [...new Set(ITEMS.flatMap(i => i.tags))].filter(Boolean),
            };

            /* ─── Type color mapping ──────────────────────────────── */
            const TYPE_COLORS = {
                Business: { bg: "var(--color-bg-accent-orange-subtlest)", border: "var(--color-bg-accent-orange-subtle)", text: "var(--color-bg-accent-orange-bolder)" },
                POI:      { bg: "var(--color-bg-accent-green-subtlest)",  border: "var(--color-bg-accent-green-subtle)",  text: "var(--color-bg-accent-green-bolder)" },
            };

            const CATEGORY_SWATCH = {
                "Accommodation":       "var(--color-bg-accent-orange-bolder)",
                "Food & Beverage":     "var(--color-bg-accent-orange-bolder)",
                "Cultural Attraction": "var(--color-bg-accent-orange-bolder)",
                "Provincial Park":     "var(--color-bg-accent-green-bolder)",
                "Retail":              "var(--color-bg-accent-orange-bolder)",
            };

            /* ─── SVG Icons ───────────────────────────────────────── */
            const Icon = ({ name, size = 16, color = "currentColor" }) => {
                const icons = {
                    search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                    chevronDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
                    plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                    x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                    check: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
                    sun: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
                    moon: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
                };
                return icons[name] || null;
            };

            /* ─── Checkbox ────────────────────────────────────────── */
            function Checkbox({ checked, onChange, size = 18 }) {
                return (
                    <div onClick={e => { e.stopPropagation(); onChange(!checked); }} style={{
                        width: size, height: size, borderRadius: 4, cursor: "pointer",
                        border: checked ? "none" : "1.5px solid var(--color-border-bold)",
                        background: checked ? "var(--color-bg-selected-bold)" : "transparent",
                        display: "flex", alignItems: "center", justifyContent: "center",
                        transition: "background .15s ease, border .15s ease",
                        flexShrink: 0,
                    }}>
                        {checked && <Icon name="check" size={12} color="var(--color-text-inverse)" />}
                    </div>
                );
            }

            /* ─── SearchBar ───────────────────────────────────────── */
            function SearchBar({ value, onChange }) {
                return (
                    <div style={{
                        display: "flex", alignItems: "center", gap: 8,
                        border: "1.5px solid var(--color-border-selected)",
                        borderRadius: 24, padding: "10px 16px",
                        background: "var(--color-bg-primary)",
                    }}>
                        <input
                            type="text"
                            placeholder="Search..."
                            value={value}
                            onChange={e => onChange(e.target.value)}
                            style={{
                                flex: 1, border: "none", outline: "none",
                                background: "transparent", fontSize: 14,
                                color: "var(--color-text-default)",
                            }}
                        />
                        <span style={{
                            fontSize: 13, fontWeight: 500,
                            color: "var(--color-text-selected)",
                            whiteSpace: "nowrap", cursor: "pointer",
                            display: "flex", alignItems: "center", gap: 2,
                        }}>
                            within my account
                            <Icon name="chevronDown" size={14} color="var(--color-text-selected)" />
                        </span>
                    </div>
                );
            }

            /* ─── SegmentTabs ─────────────────────────────────────── */
            function SegmentTabs({ activeTab, onTabChange, counts }) {
                const tabs = [
                    { key: "all",        label: "All items",  count: counts.all },
                    { key: "businesses", label: "Businesses", count: counts.businesses, swatch: "var(--color-bg-accent-orange-bolder)" },
                    { key: "pois",       label: "POIs",       count: counts.pois,       swatch: "var(--color-bg-accent-green-bolder)" },
                ];
                return (
                    <div style={{ display: "flex", gap: 8 }}>
                        {tabs.map(t => {
                            const isActive = activeTab === t.key;
                            return (
                                <div key={t.key} className={`segment-tab ${isActive ? "active" : ""}`}
                                    onClick={() => onTabChange(t.key)}
                                    style={{
                                        display: "flex", alignItems: "center", gap: 8,
                                        padding: "8px 16px", borderRadius: 8,
                                        border: isActive ? "1.5px solid var(--color-border-selected)" : "1.5px solid var(--color-border-default)",
                                        background: isActive ? "var(--color-bg-selected-bold)" : "var(--color-bg-primary)",
                                        color: isActive ? "var(--color-text-inverse)" : "var(--color-text-default)",
                                        fontSize: 14, fontWeight: 500,
                                    }}>
                                    {t.swatch && !isActive && <div style={{
                                        width: 10, height: 10, borderRadius: 2,
                                        background: t.swatch, flexShrink: 0,
                                    }} />}
                                    <span>{t.label}</span>
                                    <span style={{
                                        fontFamily: "'JetBrains Mono', monospace", fontSize: 13,
                                        opacity: isActive ? 0.8 : 0.6,
                                    }}>{t.count}</span>
                                </div>
                            );
                        })}
                    </div>
                );
            }

            /* ─── FilterBar ───────────────────────────────────────── */
            function FilterBar({ filters, onAddFilter, onRemoveFilter, onUpdateFilter }) {
                const [showAddMenu, setShowAddMenu] = useState(false);
                const addRef = useRef(null);

                // close dropdown on outside click
                useEffect(() => {
                    if (!showAddMenu) return;
                    const handler = (e) => {
                        if (addRef.current && !addRef.current.contains(e.target)) setShowAddMenu(false);
                    };
                    document.addEventListener("mousedown", handler);
                    return () => document.removeEventListener("mousedown", handler);
                }, [showAddMenu]);

                const usedFields = filters.map(f => f.field);
                const availableFields = Object.keys(FILTER_OPTIONS).filter(f => !usedFields.includes(f));

                return (
                    <div style={{ display: "flex", flexWrap: "wrap", alignItems: "center", gap: 8 }}>
                        {filters.map((f, i) => (
                            <FilterPill key={f.field} filter={f}
                                onRemove={() => onRemoveFilter(i)}
                                onUpdate={(vals) => onUpdateFilter(i, vals)} />
                        ))}
                        <div ref={addRef} style={{ position: "relative" }}>
                            <button onClick={() => setShowAddMenu(!showAddMenu)} style={{
                                display: "flex", alignItems: "center", gap: 4,
                                padding: "6px 12px", borderRadius: 20,
                                border: "1.5px solid var(--color-border-default)",
                                background: "var(--color-bg-primary)", cursor: "pointer",
                                fontSize: 13, fontWeight: 500, color: "var(--color-text-default)",
                            }}>
                                Add filter <Icon name="plus" size={14} />
                            </button>
                            {showAddMenu && availableFields.length > 0 && (
                                <div className="filter-dropdown" style={{
                                    position: "absolute", top: "calc(100% + 4px)", left: 0, zIndex: 20,
                                    background: "var(--color-elevation-surface)", borderRadius: 10,
                                    boxShadow: "var(--shadow-overlay)", minWidth: 180,
                                    border: "1px solid var(--color-border-default)",
                                    padding: "4px 0",
                                }}>
                                    {availableFields.map(field => (
                                        <div key={field} onClick={() => {
                                            onAddFilter({ field, values: [] });
                                            setShowAddMenu(false);
                                        }} style={{
                                            padding: "8px 14px", cursor: "pointer", fontSize: 13,
                                            fontWeight: 500, color: "var(--color-text-default)",
                                            transition: "background .1s",
                                        }}
                                        onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                        onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                            {field}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        {filters.length === 0 && (
                            <span style={{ fontSize: 13, color: "var(--color-text-subtle)", marginLeft: 4 }}>
                                Apply filters to find exactly what you're looking for.
                            </span>
                        )}
                    </div>
                );
            }

            /* ─── FilterPill ──────────────────────────────────────── */
            function FilterPill({ filter, onRemove, onUpdate }) {
                const [open, setOpen] = useState(false);
                const ref = useRef(null);

                useEffect(() => {
                    if (!open) return;
                    const handler = (e) => {
                        if (ref.current && !ref.current.contains(e.target)) setOpen(false);
                    };
                    document.addEventListener("mousedown", handler);
                    return () => document.removeEventListener("mousedown", handler);
                }, [open]);

                const options = FILTER_OPTIONS[filter.field] || [];
                const label = filter.values.length > 0 ? filter.values.join(", ") : "Any";

                return (
                    <div ref={ref} style={{ position: "relative" }}>
                        <div className="filter-pill" onClick={() => setOpen(!open)} style={{
                            display: "flex", alignItems: "center", gap: 4,
                            padding: "6px 10px 6px 12px", borderRadius: 20,
                            border: "1.5px solid var(--color-bg-accent-blue-subtle)",
                            background: "var(--color-bg-accent-blue-subtlest)",
                            cursor: "pointer", fontSize: 13, fontWeight: 500,
                            color: "var(--color-text-selected)",
                        }}>
                            <span>{filter.field}: {label}</span>
                            <Icon name="chevronDown" size={14} color="var(--color-text-selected)" />
                        </div>
                        {open && (
                            <div className="filter-dropdown" style={{
                                position: "absolute", top: "calc(100% + 4px)", left: 0, zIndex: 20,
                                background: "var(--color-elevation-surface)", borderRadius: 10,
                                boxShadow: "var(--shadow-overlay)", minWidth: 200,
                                border: "1px solid var(--color-border-default)",
                                padding: "4px 0",
                            }}>
                                {options.map(opt => {
                                    const selected = filter.values.includes(opt);
                                    return (
                                        <div key={opt} onClick={() => {
                                            const next = selected
                                                ? filter.values.filter(v => v !== opt)
                                                : [...filter.values, opt];
                                            onUpdate(next);
                                        }} style={{
                                            padding: "8px 14px", cursor: "pointer", fontSize: 13,
                                            fontWeight: 500, display: "flex", alignItems: "center", gap: 8,
                                            color: "var(--color-text-default)",
                                            transition: "background .1s",
                                        }}
                                        onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                        onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                            <Checkbox checked={selected} onChange={() => {}} size={16} />
                                            {opt}
                                        </div>
                                    );
                                })}
                                <div style={{ borderTop: "1px solid var(--color-border-default)", margin: "4px 0" }} />
                                <div onClick={() => { onRemove(); setOpen(false); }} style={{
                                    padding: "8px 14px", cursor: "pointer", fontSize: 13,
                                    fontWeight: 500, color: "#D14D41",
                                    transition: "background .1s",
                                }}
                                onMouseEnter={e => e.currentTarget.style.background = "var(--color-bg-secondary)"}
                                onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                                    Remove filter
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            /* ─── ResultRow ───────────────────────────────────────── */
            function ResultRow({ item, index, checked, onToggle }) {
                const swatch = CATEGORY_SWATCH[item.category] || "var(--color-bg-neutral-bold)";
                return (
                    <div className="result-row" onClick={() => onToggle(item.id)} style={{
                        display: "flex", alignItems: "center", gap: 12,
                        padding: "14px 16px", cursor: "pointer",
                        borderBottom: "1px solid var(--color-border-default)",
                    }}>
                        <Checkbox checked={checked} onChange={() => onToggle(item.id)} />
                        <span style={{ flex: 1, fontSize: 14, fontWeight: 600 }}>{item.name}</span>
                        <span style={{ fontSize: 13, color: "var(--color-text-subtle)", whiteSpace: "nowrap" }}>
                            {item.category}
                        </span>
                        <div style={{
                            width: 14, height: 14, borderRadius: 3,
                            background: swatch, flexShrink: 0,
                        }} />
                        <span style={{
                            fontFamily: "'JetBrains Mono', monospace", fontSize: 12,
                            color: "var(--color-text-subtlest)", width: 20, textAlign: "right",
                        }}>{index + 1}</span>
                    </div>
                );
            }

            /* ─── ResultsList ─────────────────────────────────────── */
            function ResultsList({ items, selectedIds, onToggle, onSelectAll }) {
                const allChecked = items.length > 0 && items.every(i => selectedIds.has(i.id));
                const someChecked = items.some(i => selectedIds.has(i.id));

                return (
                    <div style={{ flex: 1, overflow: "auto" }}>
                        {/* Header */}
                        <div style={{
                            display: "flex", alignItems: "center", gap: 12,
                            padding: "10px 16px",
                            borderBottom: "1px solid var(--color-border-default)",
                            background: "var(--color-bg-secondary)",
                            position: "sticky", top: 0, zIndex: 2,
                        }}>
                            <Checkbox checked={allChecked} onChange={() => onSelectAll(!allChecked)} />
                            <span style={{ flex: 1, fontSize: 13, color: "var(--color-text-subtle)" }}>
                                Select all
                            </span>
                            <span style={{
                                fontFamily: "'JetBrains Mono', monospace", fontSize: 12,
                                color: "var(--color-text-subtlest)",
                            }}>Sort: Name</span>
                        </div>
                        {/* Rows */}
                        {items.map((item, i) => (
                            <ResultRow key={item.id} item={item} index={i}
                                checked={selectedIds.has(item.id)}
                                onToggle={onToggle} />
                        ))}
                        {items.length === 0 && (
                            <div style={{
                                padding: "48px 16px", textAlign: "center",
                                color: "var(--color-text-subtlest)", fontSize: 14,
                            }}>
                                No results match your filters.
                            </div>
                        )}
                    </div>
                );
            }

            /* ─── TypeBadge ───────────────────────────────────────── */
            function TypeBadge({ type }) {
                const c = TYPE_COLORS[type] || TYPE_COLORS.Business;
                return (
                    <span style={{
                        display: "inline-block", padding: "2px 10px", borderRadius: 12,
                        fontSize: 12, fontWeight: 600,
                        border: `1.5px solid ${c.border}`,
                        color: c.text, background: c.bg,
                    }}>{type}</span>
                );
            }

            /* ─── SelectionTray ───────────────────────────────────── */
            function SelectionTray({ selectedItems, onRemove, onClearAll }) {
                const [expanded, setExpanded] = useState(false);
                const count = selectedItems.length;

                if (count === 0) return null;

                return (
                    <div className={`selection-tray ${count === 0 ? "hidden" : ""}`} style={{
                        position: "absolute", bottom: 0, left: 0, right: 0, zIndex: 10,
                        background: "var(--color-bg-secondary)",
                        borderTop: "1px solid var(--color-border-default)",
                    }}>
                        {/* Review panel */}
                        <div className={`review-panel ${expanded ? "expanded" : "collapsed"}`}>
                            <div style={{
                                maxHeight: 360, overflowY: "auto", padding: "12px 20px",
                            }}>
                                {selectedItems.map(item => (
                                    <div key={item.id} className="selection-card" style={{
                                        display: "flex", alignItems: "center", gap: 12,
                                        padding: "12px 14px",
                                        borderBottom: "1px solid var(--color-border-default)",
                                        borderLeft: "3px solid var(--color-border-default)",
                                        background: "var(--color-bg-primary)",
                                        marginBottom: 1,
                                    }}>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontSize: 14, fontWeight: 600 }}>{item.name}</div>
                                            <div style={{ fontSize: 12, color: "var(--color-text-subtle)", marginTop: 2 }}>
                                                {item.category}
                                            </div>
                                        </div>
                                        <TypeBadge type={item.type} />
                                        <div onClick={() => onRemove(item.id)} style={{
                                            cursor: "pointer", padding: 4, borderRadius: 99,
                                            display: "flex", alignItems: "center", justifyContent: "center",
                                            color: "var(--color-icon-subtle)",
                                            transition: "color .15s ease",
                                        }}
                                        onMouseEnter={e => e.currentTarget.style.color = "var(--color-text-default)"}
                                        onMouseLeave={e => e.currentTarget.style.color = "var(--color-icon-subtle)"}>
                                            <Icon name="x" size={16} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Bottom bar */}
                        <div style={{
                            display: "flex", alignItems: "center", gap: 12,
                            padding: "14px 20px",
                            background: "var(--color-bg-selected-bold)",
                            borderRadius: "0",
                        }}>
                            <div style={{
                                display: "flex", alignItems: "center", justifyContent: "center",
                                background: "var(--color-bg-accent-blue-subtle)",
                                color: "#FFFDF6", fontWeight: 600,
                                fontSize: 13, borderRadius: 6, minWidth: 28, height: 28,
                                padding: "0 6px",
                            }}>{count}</div>
                            <span style={{ fontSize: 14, fontWeight: 500, color: "#FFFDF6" }}>
                                items selected
                            </span>
                            <div style={{ flex: 1 }} />
                            <button onClick={() => setExpanded(!expanded)} style={{
                                padding: "8px 20px", borderRadius: 20,
                                border: "1.5px solid rgba(255,255,255,.3)",
                                background: "transparent", cursor: "pointer",
                                fontSize: 13, fontWeight: 500, color: "#FFFDF6",
                            }}>
                                {expanded ? "Collapse" : "Review"}
                            </button>
                            <button onClick={() => alert("Items added to Day 1!")} style={{
                                padding: "8px 20px", borderRadius: 20,
                                border: "1.5px solid var(--color-bg-accent-blue-subtle)",
                                background: "var(--color-bg-accent-blue-subtler)", cursor: "pointer",
                                fontSize: 13, fontWeight: 600, color: "#FFFDF6",
                            }}>
                                Add items to Day 1
                            </button>
                        </div>
                    </div>
                );
            }

            /* ─── MapPlaceholder ──────────────────────────────────── */
            function MapPlaceholder() {
                return (
                    <div style={{
                        flex: 1, background: "#CED5AB",
                        display: "flex", alignItems: "center", justifyContent: "center",
                        color: "rgba(0,0,0,.15)", fontSize: 18, fontWeight: 600,
                        letterSpacing: 1,
                    }}>
                    </div>
                );
            }

            /* ─── App ─────────────────────────────────────────────── */
            function App() {
                const [isDark, setIsDark] = useState(false);
                const [searchQuery, setSearchQuery] = useState("");
                const [activeTab, setActiveTab] = useState("all");
                const [filters, setFilters] = useState([]);
                const [selectedIds, setSelectedIds] = useState(new Set());

                const toggleDark = useCallback(() => {
                    setIsDark(prev => {
                        const next = !prev;
                        document.documentElement.classList.toggle("dark", next);
                        return next;
                    });
                }, []);

                /* filtering pipeline */
                const filteredItems = useMemo(() => {
                    let result = [...ITEMS];

                    // tab filter
                    if (activeTab === "businesses") result = result.filter(i => i.type === "Business");
                    if (activeTab === "pois") result = result.filter(i => i.type === "POI");

                    // active filters
                    for (const f of filters) {
                        if (f.values.length === 0) continue;
                        if (f.field === "Region") result = result.filter(i => f.values.includes(i.region));
                        if (f.field === "Category") result = result.filter(i => f.values.includes(i.category));
                        if (f.field === "Custom Tag") result = result.filter(i => i.tags.some(t => f.values.includes(t)));
                    }

                    // search
                    if (searchQuery.trim()) {
                        const q = searchQuery.toLowerCase();
                        result = result.filter(i =>
                            i.name.toLowerCase().includes(q) ||
                            i.category.toLowerCase().includes(q)
                        );
                    }

                    // sort by name
                    result.sort((a, b) => a.name.localeCompare(b.name));
                    return result;
                }, [activeTab, filters, searchQuery]);

                /* counts for segment tabs */
                const counts = useMemo(() => {
                    let base = [...ITEMS];
                    for (const f of filters) {
                        if (f.values.length === 0) continue;
                        if (f.field === "Region") base = base.filter(i => f.values.includes(i.region));
                        if (f.field === "Category") base = base.filter(i => f.values.includes(i.category));
                        if (f.field === "Custom Tag") base = base.filter(i => i.tags.some(t => f.values.includes(t)));
                    }
                    if (searchQuery.trim()) {
                        const q = searchQuery.toLowerCase();
                        base = base.filter(i =>
                            i.name.toLowerCase().includes(q) ||
                            i.category.toLowerCase().includes(q)
                        );
                    }
                    return {
                        all: base.length,
                        businesses: base.filter(i => i.type === "Business").length,
                        pois: base.filter(i => i.type === "POI").length,
                    };
                }, [filters, searchQuery]);

                const toggleItem = useCallback((id) => {
                    setSelectedIds(prev => {
                        const next = new Set(prev);
                        if (next.has(id)) next.delete(id); else next.add(id);
                        return next;
                    });
                }, []);

                const selectAll = useCallback((selectAll) => {
                    if (selectAll) {
                        setSelectedIds(prev => {
                            const next = new Set(prev);
                            filteredItems.forEach(i => next.add(i.id));
                            return next;
                        });
                    } else {
                        setSelectedIds(prev => {
                            const next = new Set(prev);
                            filteredItems.forEach(i => next.delete(i.id));
                            return next;
                        });
                    }
                }, [filteredItems]);

                const selectedItems = ITEMS.filter(i => selectedIds.has(i.id));

                const addFilter = useCallback((f) => setFilters(prev => [...prev, f]), []);
                const removeFilter = useCallback((idx) => setFilters(prev => prev.filter((_, i) => i !== idx)), []);
                const updateFilter = useCallback((idx, values) => {
                    setFilters(prev => prev.map((f, i) => i === idx ? { ...f, values } : f));
                }, []);

                return (
                    <div style={{
                        display: "flex", height: "100%", width: "100%",
                        fontFamily: "var(--body-font), sans-serif",
                        position: "relative",
                    }}>
                        {/* ─── Left sidebar ───────────────────────── */}
                        <div style={{
                            width: "45%", minWidth: 420, display: "flex", flexDirection: "column",
                            position: "relative", borderRight: "1px solid var(--color-border-default)",
                        }}>
                            {/* Header */}
                            <div style={{ padding: "36px 28px 0" }}>
                                <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between" }}>
                                    <h1 style={{
                                        fontFamily: "'Platypi', serif", fontSize: 28, fontWeight: 600,
                                        lineHeight: 1.2, margin: 0,
                                    }}>Explorer</h1>
                                    <button onClick={toggleDark} style={{
                                        background: "none", border: "none", cursor: "pointer",
                                        padding: 6, borderRadius: 8, color: "var(--color-icon-subtle)",
                                        display: "flex", alignItems: "center", justifyContent: "center",
                                    }}>
                                        <Icon name={isDark ? "sun" : "moon"} size={18} />
                                    </button>
                                </div>
                                <p style={{
                                    fontSize: 14, color: "var(--color-text-subtle)",
                                    lineHeight: 1.5, margin: "8px 0 20px",
                                }}>
                                    Search within your account or across Whereabouts' extensive database of
                                    tourism businesses, organizations, and points of interest.
                                </p>
                                <SearchBar value={searchQuery} onChange={setSearchQuery} />
                                <div style={{ marginTop: 16 }}>
                                    <SegmentTabs activeTab={activeTab} onTabChange={setActiveTab} counts={counts} />
                                </div>
                                <div style={{ marginTop: 12, marginBottom: 8 }}>
                                    <FilterBar
                                        filters={filters}
                                        onAddFilter={addFilter}
                                        onRemoveFilter={removeFilter}
                                        onUpdateFilter={updateFilter}
                                    />
                                </div>
                            </div>

                            {/* Results */}
                            <ResultsList
                                items={filteredItems}
                                selectedIds={selectedIds}
                                onToggle={toggleItem}
                                onSelectAll={selectAll}
                            />

                            {/* Selection tray */}
                            <SelectionTray
                                selectedItems={selectedItems}
                                onRemove={(id) => toggleItem(id)}
                                onClearAll={() => setSelectedIds(new Set())}
                            />
                        </div>

                        {/* ─── Right panel (map placeholder) ──────── */}
                        <MapPlaceholder />
                    </div>
                );
            }

            /* ─── Mount ────────────────────────────────────────────── */
            ReactDOM.createRoot(document.getElementById("root")).render(<App />);
        </script>
    </body>
</html>
